<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockbee Market Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background-color: #f9fafb;
        }
        .chart-container {
            position: relative;
        }
        .indicator-checkbox {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        .indicator-checkbox:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .indicator-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 10px;
            top: -1px;
            left: 2px;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="p-6 bg-gray-50 min-h-screen">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Stockbee Market Monitor</h1>
                            <p class="text-gray-600 mt-2">Real-time breadth analysis with customizable indicators</p>
                        </div>
                        <div class="text-right mt-4 lg:mt-0" id="sentiment-display">
                            <div class="text-lg font-semibold" id="sentiment-text">Loading...</div>
                            <div class="text-sm text-gray-500" id="sentiment-desc">Analyzing live market data</div>
                        </div>
                    </div>
                    
                    <!-- Indicator Selection Panel -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">Select Indicators to Display</h3>
                            <div class="flex items-center gap-2">
                                <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span id="data-status" class="px-2 py-1 rounded bg-gray-200 text-gray-600">Checking...</span>
                                    <span id="last-check" class="text-gray-500">--</span>
                                </div>
                                <button id="refresh-data" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    Refresh Data
                                </button>
                                <button id="auto-refresh-toggle" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    Auto: OFF
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Primary Breadth Indicators</h4>
                                <div class="space-y-2" id="primary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Secondary Breadth Indicators</h4>
                                <div class="space-y-2" id="secondary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Market Indicators</h4>
                                <div class="space-y-2" id="market-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 mt-4">
                            <label class="text-sm text-gray-600">
                                Time Range:
                                <select id="time-range" class="ml-2 px-3 py-1 border border-gray-300 rounded">
                                    <option value="7">Last 7 days</option>
                                    <option value="14">Last 2 weeks</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="60">Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="180">Last 6 months</option>
                                    <option value="365">Last year</option>
                                    <option value="0">All data</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white rounded-lg border">
                        <canvas id="stockChart" style="width:100%;height:500px;"></canvas>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Current Readings</h3>
                        <div class="space-y-2 text-sm" id="current-readings">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Key Levels</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>T2108 &lt; 20:</span>
                                <span class="text-green-600">Oversold</span>
                            </div>
                            <div class="flex justify-between">
                                <span>5-Day Ratio &gt; 2.0:</span>
                                <span class="text-green-600">Breadth Thrust</span>
                            </div>
                            <div class="flex justify-between">
                                <span>4% Down &gt; 300:</span>
                                <span class="text-red-600">High Selling</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Up 4% &gt; 1000:</span>
                                <span class="text-green-600">Extreme Buying</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Market Stats</h3>
                        <div class="space-y-2 text-sm" id="market-stats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Data Info</h3>
                        <div class="space-y-2 text-sm" id="data-info">
                            <div class="flex justify-between">
                                <span>Last Update:</span>
                                <span id="last-update">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Records:</span>
                                <span id="total-records">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Date Range:</span>
                                <span id="date-range" class="text-xs">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data Source:</span>
                                <span class="text-blue-600">Live Google Sheets</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <div class="flex items-center">
                        <div class="text-blue-600 mr-3">ðŸ“Š</div>
                        <div>
                            <h4 class="font-medium text-blue-800">Live Data Integration</h4>
                            <p class="text-sm text-blue-700 mt-1">Charts display real market breadth data from your Google Sheets. Use the indicator checkboxes above to customize your view.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let marketData = [];
        let selectedIndicators = new Set(['Number of stocks up 4% plus today', 'Number of stocks down 4% plus today', 'T2108']);
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let lastDataHash = null;
        let lastCheckTime = null;
        
        // Define indicator configurations
        const indicatorConfig = {
            // Primary Breadth Indicators
            'Number of stocks up 4% plus today': { color: '#00C851', category: 'primary', yAxis: 'left', name: 'Stocks Up 4%+' },
            'Number of stocks down 4% plus today': { color: '#ff4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 4%+' },
            '5 day ratio': { color: '#8b5cf6', category: 'primary', yAxis: 'right', name: '5-Day Ratio' },
            '10 day  ratio ': { color: '#f59e0b', category: 'primary', yAxis: 'right', name: '10-Day Ratio' },
            'Number of stocks up 25% plus in a quarter': { color: '#10b981', category: 'primary', yAxis: 'left', name: 'Stocks Up 25%+ Quarter' },
            'Number of stocks down 25% + in a quarter': { color: '#ef4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 25%+ Quarter' },
            
            // Secondary Breadth Indicators
            'Number of stocks up 25% + in a month': { color: '#06b6d4', category: 'secondary', yAxis: 'left', name: 'Stocks Up 25%+ Month' },
            'Number of stocks down 25% + in a month': { color: '#dc2626', category: 'secondary', yAxis: 'left', name: 'Stocks Down 25%+ Month' },
            'Number of stocks up 50% + in a month': { color: '#16a34a', category: 'secondary', yAxis: 'left', name: 'Stocks Up 50%+ Month' },
            'Number of stocks down 50% + in a month': { color: '#b91c1c', category: 'secondary', yAxis: 'left', name: 'Stocks Down 50%+ Month' },
            'Number of stocks up 13% + in 34 days': { color: '#0ea5e9', category: 'secondary', yAxis: 'left', name: 'Stocks Up 13%+ (34d)' },
            'Number of stocks down 13% + in 34 days': { color: '#e11d48', category: 'secondary', yAxis: 'left', name: 'Stocks Down 13%+ (34d)' },
            
            // Market Indicators
            'T2108': { color: '#ff6600', category: 'market', yAxis: 'right', name: 'T2108 (%)', dashArray: '5,5' },
            'S&P': { color: '#6366f1', category: 'market', yAxis: 'right', name: 'S&P 500', dashArray: '10,5' },
            ' Worden Common stock universe': { color: '#84cc16', category: 'market', yAxis: 'left', name: 'Total Universe' }
        };

        // Generate hash for data comparison
        function generateDataHash(data) {
            if (!data || data.length === 0) return null;
            const firstRow = data[0];
            const hashString = JSON.stringify({
                date: firstRow.Date,
                upStocks: firstRow['Number of stocks up 4% plus today'],
                downStocks: firstRow['Number of stocks down 4% plus today'],
                t2108: firstRow['T2108'],
                recordCount: data.length
            });
            return btoa(hashString); // Simple base64 hash
        }

        // Check for fresh data from Google Sheets
        async function checkForFreshData() {
            try {
                updateDataStatus('checking', 'Checking for updates...');
                
                // Fetch directly from Google Sheets CSV
                const response = await fetch('https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv&t=' + Date.now());
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                // Parse just enough to get the latest data point
                const headers = lines[1].split(',');
                const latestRow = {};
                
                if (lines.length > 2) {
                    const values = lines[2].split(',');
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if (value && header !== 'Date') {
                            value = value.replace(/[",]/g, '');
                            if (!isNaN(value) && value !== '') {
                                value = parseFloat(value);
                            }
                        }
                        latestRow[header] = value;
                    });
                }
                
                // Generate hash for comparison
                const newDataHash = generateDataHash([latestRow]);
                lastCheckTime = new Date();
                
                if (lastDataHash === null) {
                    lastDataHash = newDataHash;
                    updateDataStatus('current', 'Data loaded');
                    return { hasUpdate: false, isFirstLoad: true };
                } else if (newDataHash !== lastDataHash) {
                    lastDataHash = newDataHash;
                    updateDataStatus('updated', 'New data available!');
                    return { hasUpdate: true, latestData: latestRow };
                } else {
                    updateDataStatus('current', 'Data is current');
                    return { hasUpdate: false };
                }
                
            } catch (error) {
                console.error('Error checking for fresh data:', error);
                updateDataStatus('error', 'Check failed');
                return { hasUpdate: false, error: true };
            }
        }

        // Update data status display
        function updateDataStatus(status, message) {
            const statusElement = document.getElementById('data-status');
            const lastCheckElement = document.getElementById('last-check');
            
            // Update status badge
            statusElement.textContent = message;
            statusElement.className = 'px-2 py-1 rounded text-xs ';
            
            switch (status) {
                case 'checking':
                    statusElement.className += 'bg-yellow-200 text-yellow-800';
                    break;
                case 'current':
                    statusElement.className += 'bg-green-200 text-green-800';
                    break;
                case 'updated':
                    statusElement.className += 'bg-blue-200 text-blue-800';
                    break;
                case 'error':
                    statusElement.className += 'bg-red-200 text-red-800';
                    break;
                default:
                    statusElement.className += 'bg-gray-200 text-gray-600';
            }
            
            // Update last check time
            if (lastCheckTime) {
                lastCheckElement.textContent = `Last: ${lastCheckTime.toLocaleTimeString()}`;
            }
        }

        // Load and parse CSV data (enhanced version)
        async function loadMarketData(skipFreshCheck = false) {
            try {
                document.getElementById('loading-spinner').style.display = 'block';
                
                // Check for fresh data first (unless skipped)
                if (!skipFreshCheck) {
                    const freshCheck = await checkForFreshData();
                    if (!freshCheck.hasUpdate && !freshCheck.isFirstLoad && !freshCheck.error) {
                        document.getElementById('loading-spinner').style.display = 'none';
                        return; // No update needed
                    }
                }
                
                // Fetch data directly from Google Sheets with cache-busting
                const googleSheetsUrl = `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv&t=${Date.now()}`;
                console.log('Fetching data from:', googleSheetsUrl);
                const response = await fetch(googleSheetsUrl);
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                // Skip header rows and parse data
                const headers = lines[1].split(',');
                const data = [];
                
                for (let i = 2; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length && values[0]) {
                        const row = {};
                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (value && header !== 'Date') {
                                // Remove quotes and commas from numbers
                                value = value.replace(/[",]/g, '');
                                if (!isNaN(value) && value !== '') {
                                    value = parseFloat(value);
                                }
                            }
                            row[header] = value;
                        });
                        
                        // Parse date
                        if (row.Date) {
                            row.parsedDate = new Date(row.Date);
                        }
                        
                        data.push(row);
                    }
                }
                
                marketData = data.reverse(); // Most recent first
                lastDataHash = generateDataHash(marketData);
                
                // Debug: Log data range
                if (marketData.length > 0) {
                    console.log(`Loaded ${marketData.length} records`);
                    console.log(`Latest date: ${marketData[0].Date}`);
                    console.log(`Oldest date: ${marketData[marketData.length - 1].Date}`);
                }
                
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('current', 'Data refreshed');
                updateDataInfo();
                createIndicatorCheckboxes();
                drawChart();
                updateCurrentReadings();
                
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('error', 'Load failed');
                alert('Error loading market data. Please check your connection.');
            }
        }

        // Toggle auto-refresh functionality
        function toggleAutoRefresh() {
            const toggleButton = document.getElementById('auto-refresh-toggle');
            
            if (autoRefreshEnabled) {
                // Disable auto-refresh
                autoRefreshEnabled = false;
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                toggleButton.textContent = 'Auto: OFF';
                toggleButton.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700';
            } else {
                // Enable auto-refresh
                autoRefreshEnabled = true;
                toggleButton.textContent = 'Auto: ON';
                toggleButton.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
                
                // Check every 2 minutes
                autoRefreshInterval = setInterval(async () => {
                    const freshCheck = await checkForFreshData();
                    if (freshCheck.hasUpdate) {
                        console.log('Auto-refresh: New data detected, refreshing...');
                        await loadMarketData(true); // Skip fresh check since we just did it
                    }
                }, 120000); // 2 minutes
                
                // Do initial check
                checkForFreshData();
            }
        }

        // Create indicator selection checkboxes
        function createIndicatorCheckboxes() {
            const primaryContainer = document.getElementById('primary-indicators');
            const secondaryContainer = document.getElementById('secondary-indicators');
            const marketContainer = document.getElementById('market-indicators');
            
            // Clear existing checkboxes to prevent duplicates
            primaryContainer.innerHTML = '';
            secondaryContainer.innerHTML = '';
            marketContainer.innerHTML = '';
            
            Object.entries(indicatorConfig).forEach(([key, config]) => {
                const container = config.category === 'primary' ? primaryContainer :
                                config.category === 'secondary' ? secondaryContainer : marketContainer;
                
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = key;
                checkbox.className = 'indicator-checkbox';
                checkbox.checked = selectedIndicators.has(key);
                
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedIndicators.add(key);
                    } else {
                        selectedIndicators.delete(key);
                    }
                    drawChart();
                });
                
                const label = document.createElement('label');
                label.htmlFor = key;
                label.className = 'text-sm text-gray-700 cursor-pointer flex items-center';
                
                const colorBox = document.createElement('span');
                colorBox.className = 'w-3 h-3 rounded mr-2';
                colorBox.style.backgroundColor = config.color;
                
                label.appendChild(colorBox);
                label.appendChild(document.createTextNode(config.name));
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // Update data information display
        function updateDataInfo() {
            if (marketData.length > 0) {
                const latestDate = marketData[0].Date;
                const oldestDate = marketData[marketData.length - 1].Date;
                
                document.getElementById('last-update').textContent = latestDate;
                document.getElementById('total-records').textContent = marketData.length.toLocaleString();
                
                // Add date range info if we have multiple records
                if (marketData.length > 1) {
                    const rangeInfo = document.getElementById('date-range');
                    if (rangeInfo) {
                        rangeInfo.textContent = `${oldestDate} - ${latestDate}`;
                    }
                }
            }
        }

        // Update current readings
        function updateCurrentReadings() {
            if (marketData.length === 0) return;
            
            const latest = marketData[0];
            const container = document.getElementById('current-readings');
            
            const readings = [
                { label: 'Stocks Up 4%+', value: latest['Number of stocks up 4% plus today'], format: 'number' },
                { label: 'Stocks Down 4%+', value: latest['Number of stocks down 4% plus today'], format: 'number' },
                { label: '5-Day Ratio', value: latest['5 day ratio'], format: 'decimal' },
                { label: 'T2108', value: latest['T2108'], format: 'percent' },
                { label: 'S&P 500', value: latest['S&P'], format: 'number' }
            ];
            
            container.innerHTML = readings.map(reading => {
                let displayValue = '--';
                if (reading.value !== undefined && reading.value !== null) {
                    if (reading.format === 'number') {
                        displayValue = reading.value.toLocaleString();
                    } else if (reading.format === 'decimal') {
                        displayValue = reading.value.toFixed(2);
                    } else if (reading.format === 'percent') {
                        displayValue = reading.value.toFixed(1) + '%';
                    }
                }
                
                return `
                    <div class="flex justify-between">
                        <span>${reading.label}:</span>
                        <span class="font-semibold">${displayValue}</span>
                    </div>
                `;
            }).join('');
            
            // Update market stats
            const statsContainer = document.getElementById('market-stats');
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            
            statsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span>Trend:</span>
                    <span class="${ratio5day > 1.5 ? 'text-green-600' : ratio5day < 0.8 ? 'text-red-600' : 'text-yellow-600'}">${ratio5day > 1.5 ? 'Bullish' : ratio5day < 0.8 ? 'Bearish' : 'Neutral'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Breadth:</span>
                    <span class="${upStocks > downStocks ? 'text-green-600' : 'text-red-600'}">${upStocks > downStocks ? 'Positive' : 'Negative'}</span>
                </div>
                <div class="flex justify-between">
                    <span>T2108 Level:</span>
                    <span class="${t2108 > 60 ? 'text-green-600' : t2108 < 30 ? 'text-red-600' : 'text-yellow-600'}">${t2108 > 60 ? 'Strong' : t2108 < 30 ? 'Weak' : 'Neutral'}</span>
                </div>
            `;
            
            // Update sentiment
            updateSentiment(latest);
        }

        // Update market sentiment
        function updateSentiment(latest) {
            const sentimentText = document.getElementById('sentiment-text');
            const sentimentDesc = document.getElementById('sentiment-desc');
            
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            
            let sentiment = 'Neutral';
            let color = '#f59e0b';
            let description = 'Mixed breadth signals';
            
            if (upStocks > 1000 && ratio5day > 2.0) {
                sentiment = 'Extremely Bullish';
                color = '#00C851';
                description = 'Massive breadth thrust in progress';
            } else if (downStocks > 500 && t2108 < 20) {
                sentiment = 'Extremely Bearish';
                color = '#ff4444';
                description = 'Severe selling with oversold conditions';
            } else if (upStocks > 400 && ratio5day > 1.8) {
                sentiment = 'Very Bullish';
                color = '#10b981';
                description = 'Strong positive breadth momentum';
            } else if (downStocks > 300 && ratio5day < 0.7) {
                sentiment = 'Very Bearish';
                color = '#ef4444';
                description = 'Significant selling pressure';
            } else if (ratio5day > 1.3) {
                sentiment = 'Bullish';
                color = '#22c55e';
                description = 'Positive breadth momentum';
            } else if (ratio5day < 0.8) {
                sentiment = 'Bearish';
                color = '#f87171';
                description = 'Negative breadth momentum';
            }
            
            sentimentText.textContent = sentiment;
            sentimentText.style.color = color;
            sentimentDesc.textContent = description;
        }

        // Chart rendering with Chart.js
        let chartInstance = null;
        function drawChart() {
            if (marketData.length === 0) return;

            const ctx = document.getElementById('stockChart').getContext('2d');
            const timeRange = parseInt(document.getElementById('time-range').value);

            let filteredData = marketData;
            if (timeRange > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - timeRange);
                filteredData = marketData.filter(d => {
                    if (!d.Date) return false;
                    return new Date(d.Date) >= cutoffDate;
                });
            }
            if (filteredData.length === 0) return;

            const orderedData = filteredData.slice().reverse();
            const labels = orderedData.map(d => d.Date);

            const activeIndicators = Array.from(selectedIndicators).filter(key =>
                orderedData.some(d => d[key] !== undefined && d[key] !== null)
            );
            if (activeIndicators.length === 0) return;

            const datasets = activeIndicators.map(key => {
                const config = indicatorConfig[key];
                return {
                    label: config.name,
                    data: orderedData.map(d => d[key] !== undefined && d[key] !== null ? d[key] : null),
                    borderColor: config.color,
                    backgroundColor: config.color,
                    borderDash: config.dashArray ? config.dashArray.split(',').map(Number) : undefined,
                    yAxisID: config.yAxis === 'left' ? 'y' : 'y1',
                    tension: 0.3,
                    spanGaps: true
                };
            });

            if (chartInstance) {
                chartInstance.destroy();
            }

            const rangeText = timeRange > 0
                ? `${orderedData[0].Date} to ${orderedData[orderedData.length - 1].Date}`
                : "All Historical Data";

            chartInstance = new Chart(ctx, {
                type: "line",
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: `ðŸ“… ${rangeText}` }
                    },
                    scales: {
                        y: { type: "linear", position: "left" },
                        y1: { type: "linear", position: "right", grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('time-range').addEventListener('change', drawChart);
        document.getElementById('refresh-data').addEventListener('click', () => loadMarketData(true));
        document.getElementById('auto-refresh-toggle').addEventListener('click', toggleAutoRefresh);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMarketData();
            
            // Set up periodic freshness checks (every 5 minutes when auto-refresh is off)
            setInterval(async () => {
                if (!autoRefreshEnabled) {
                    await checkForFreshData();
                }
            }, 300000); // 5 minutes
        });
        
        window.addEventListener('resize', drawChart);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockbee Market Monitor</title>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js" defer></script>
    <!-- Inline styles removed; using styles.css -->

</head>
<body>
    <div id="root">
        <div class="p-6 bg-gray-50 min-h-screen">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Stockbee Market Monitor</h1>
                            <p class="text-gray-600 mt-2">Real-time breadth analysis with customizable indicators</p>
                        </div>
                        <div class="text-right mt-4 lg:mt-0" id="sentiment-display">
                            <div class="text-lg font-semibold" id="sentiment-text">Loading...</div>
                            <div class="text-sm text-gray-500" id="sentiment-desc">Analyzing live market data</div>
                        </div>
                    </div>
                    
                    <!-- Indicator Selection Panel -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">Select Indicators to Display</h3>
                            <div class="flex items-center gap-2">
                                <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span id="data-status" class="px-2 py-1 rounded bg-gray-200 text-gray-600" aria-live="polite">Checking...</span>
                                    <span id="last-check" class="text-gray-500" aria-live="polite">--</span>
                                </div>
                                <button id="refresh-data" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    Refresh Data
                                </button>
                                <button id="auto-refresh-toggle" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    Auto: OFF
                                </button>
                                <button id="theme-toggle" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 ml-2" title="Toggle Dark/Light Theme">
                                    🌙
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Primary Breadth Indicators</h4>
                                <div class="space-y-2" id="primary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Secondary Breadth Indicators</h4>
                                <div class="space-y-2" id="secondary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Market Indicators</h4>
                                <div class="space-y-2" id="market-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-4 mt-4">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                                <select id="time-range" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="30">1 Month</option>
                                    <option value="60">2 Months</option>
                                    <option value="90">3 Months</option>
                                    <option value="180" selected>6 Months</option>
                                    <option value="0">All Data</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white rounded-lg border p-4">
                        <!-- SVG Gradient Definitions -->
                        <svg width="0" height="0" style="position: absolute;">
                            <defs>
                                <!-- Primary Breadth Gradients -->
                                <linearGradient id="emeraldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#6ee7b7;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#10b981;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="roseGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#fda4af;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#f43f5e;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#e11d48;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="violetGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#c4b5fd;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="amberGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#fcd34d;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                </linearGradient>
                                
                                <!-- Secondary Breadth Gradients -->
                                <linearGradient id="skyGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#7dd3fc;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#0ea5e9;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#0284c7;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#dc2626;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#b91c1c;stop-opacity:1" />
                                </linearGradient>
                                
                                <!-- Market Indicator Gradients -->
                                <linearGradient id="orangeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#ea580c;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#c2410c;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="indigoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#a5b4fc;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#6366f1;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#4f46e5;stop-opacity:1" />
                                </linearGradient>
                                
                                <linearGradient id="limeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#a3e635;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#65a30d;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#4d7c0f;stop-opacity:1" />
                                </linearGradient>
                                
                                <!-- Vertical Fill Gradients (for area fills) -->
                                <linearGradient id="emeraldFill" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#10b981;stop-opacity:0.1" />
                                </linearGradient>
                                
                                <linearGradient id="roseFill" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#f43f5e;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#f43f5e;stop-opacity:0.1" />
                                </linearGradient>
                                
                                <linearGradient id="skyFill" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0ea5e9;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:0.1" />
                                </linearGradient>
                            </defs>
                        </svg>
                        
                        <div class="w-full h-64 sm:h-72 md:h-80 lg:h-96 xl:h-[500px] relative">
                            <canvas id="stockChart" class="w-full h-full"></canvas>
                            
                            <!-- Vertical Crosshair Region -->
                            <div id="crosshair-region" class="crosshair-region"></div>
                            
                            <!-- Custom Tooltip Container -->
                            <div id="custom-tooltip" class="custom-tooltip light rounded-lg">
                                <div class="tooltip-arrow top"></div>
                                <div class="tooltip-header">
                                    <span id="tooltip-date"></span>
                                </div>
                                <div class="tooltip-body">
                                    <div id="tooltip-series"></div>
                                    <div id="tooltip-summary" class="tooltip-summary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Current Readings</h3>
                        <div class="space-y-2 text-sm" id="current-readings">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Key Levels</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>T2108 &lt; 20:</span>
                                <span class="text-green-600">Oversold Signal</span>
                            </div>
                            <div class="flex justify-between">
                                <span>5-Day Ratio &gt; 2.0:</span>
                                <span class="text-green-600">Breadth Thrust</span>
                            </div>
                            <div class="flex justify-between">
                                <span>4% Down &gt; 300:</span>
                                <span class="text-red-600">High Selling</span>
                            </div>
                            <div class="flex justify-between">
                                <span>25% Down/Q &lt; 200:</span>
                                <span class="text-green-600">Capitulation</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Market Stats</h3>
                        <div class="space-y-2 text-sm" id="market-stats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Data Info</h3>
                        <div class="space-y-2 text-sm" id="data-info">
                            <div class="flex justify-between">
                                <span>Last Update:</span>
                                <span id="last-update">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Records:</span>
                                <span id="total-records">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Date Range:</span>
                                <span id="date-range" class="text-xs">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data Source:</span>
                                <span class="text-blue-600">Live Google Sheets</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <div class="flex items-center">
                        <div class="text-blue-600 mr-3">📊</div>
                        <div>
                            <h4 class="font-medium text-blue-800">Live Data Integration</h4>
                            <p class="text-sm text-blue-700 mt-1">Charts display real market breadth data from your Google Sheets. Use the indicator checkboxes above to customize your view.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Market Monitor Indicators Explained Section -->
                <div class="mt-8 bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Market Monitor Indicators Explained</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Primary Indicators -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Primary Indicators</h3>
                            
                            <div class="space-y-4">
                                <div class="border-l-4 border-green-500 pl-4">
                                    <h4 class="font-medium text-gray-800">4%+ Up Stocks</h4>
                                    <p class="text-sm text-gray-600 mt-1">Number of stocks moving up 4% or more in a day. High numbers (&gt;300) indicate strong buying pressure and potential market strength.</p>
                                </div>
                                
                                <div class="border-l-4 border-red-500 pl-4">
                                    <h4 class="font-medium text-gray-800">4%+ Down Stocks</h4>
                                    <p class="text-sm text-gray-600 mt-1">Number of stocks dropping 4% or more. Spikes above 300 often signal panic selling or capitulation, potentially marking market bottoms.</p>
                                </div>
                                
                                <div class="border-l-4 border-purple-500 pl-4">
                                    <h4 class="font-medium text-gray-800">Up/Down Ratio</h4>
                                    <p class="text-sm text-gray-600 mt-1">Ratio of 4%+ up stocks to 4%+ down stocks. Values above 2.0 indicate strong breadth and bullish momentum.</p>
                                </div>
                                
                                <div class="border-l-4 border-orange-500 pl-4">
                                    <h4 class="font-medium text-gray-800">T2108 (McClellan)</h4>
                                    <p class="text-sm text-gray-600 mt-1">Percentage of stocks above their 40-day moving average. Below 20 suggests oversold conditions; above 80 indicates overbought levels.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Metrics -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Advanced Metrics</h3>
                            
                            <div class="space-y-4">
                                <div class="border-l-4 border-blue-500 pl-4">
                                    <h4 class="font-medium text-gray-800">5-Day Up/Down Ratio</h4>
                                    <p class="text-sm text-gray-600 mt-1">Moving average of the daily ratio over 5 days. Smooths out daily volatility and helps identify sustained trends.</p>
                                </div>
                                
                                <div class="border-l-4 border-yellow-500 pl-4">
                                    <h4 class="font-medium text-gray-800">25% Down Quarterly</h4>
                                    <p class="text-sm text-gray-600 mt-1">Stocks down 25%+ from quarterly highs. Values below 200 may indicate market resilience; spikes above 1000 suggest broad weakness.</p>
                                </div>
                                
                                <div class="border-l-4 border-indigo-500 pl-4">
                                    <h4 class="font-medium text-gray-800">Monthly Momentum</h4>
                                    <p class="text-sm text-gray-600 mt-1">Longer-term trend analysis showing sustained market direction over weeks rather than days.</p>
                                </div>
                                
                                <div class="border-l-4 border-teal-500 pl-4">
                                    <h4 class="font-medium text-gray-800">Market Analysis View</h4>
                                    <p class="text-sm text-gray-600 mt-1">Scatter plot analysis showing relationship between different breadth measures, helping identify market regime changes.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usage Guidelines -->
                    <div class="mt-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Usage Guidelines</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="bg-green-100 text-green-800 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h4 class="font-medium text-gray-800">Bullish Signals</h4>
                                <p class="text-sm text-gray-600 mt-2">4%+ Up &gt; 300, T2108 &lt; 20 (oversold bounce), 5-day ratio &gt; 2.0</p>
                            </div>
                            
                            <div class="text-center">
                                <div class="bg-red-100 text-red-800 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h4 class="font-medium text-gray-800">Bearish Signals</h4>
                                <p class="text-sm text-gray-600 mt-2">4%+ Down &gt; 400, T2108 &gt; 80 (overbought), 25% Down/Q &gt; 1000</p>
                            </div>
                            
                            <div class="text-center">
                                <div class="bg-yellow-100 text-yellow-800 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h4 class="font-medium text-gray-800">Caution Zones</h4>
                                <p class="text-sm text-gray-600 mt-2">Mixed signals, T2108 20-80 range, low volume on moves</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Source & Updates -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">Data Source</h4>
                                <p class="text-sm text-gray-600 mt-1">Market breadth data sourced from Worden TC2000 universe, updated daily after market close.</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-sm text-gray-600">Live data connection</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline script removed; using external script.js -->
    <!-- script.js already included in <head> with defer -->
    <!--
    <script>
        let marketData = [];
        let selectedIndicators = new Set(['Number of stocks up 4% plus today', 'Number of stocks down 4% plus today', 'T2108']);
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let lastDataHash = null;
        let lastCheckTime = null;
        
        // Define indicator configurations with SVG gradient references
        const indicatorConfig = {
            // Primary Breadth Indicators - Emerald/Rose theme
            'Number of stocks up 4% plus today': { 
                color: '#10b981', // emerald-500
                gradientId: 'emeraldGradient',
                fillGradientId: 'emeraldFill',
                gradientColors: ['#6ee7b7', '#10b981'], // emerald-300 to emerald-500
                category: 'primary', 
                yAxis: 'left', 
                name: 'Stocks Up 4%+' 
            },
            'Number of stocks down 4% plus today': { 
                color: '#f43f5e', // rose-500
                gradientId: 'roseGradient',
                fillGradientId: 'roseFill',
                gradientColors: ['#fda4af', '#f43f5e'], // rose-300 to rose-500
                category: 'primary', 
                yAxis: 'left', 
                name: 'Stocks Down 4%+' 
            },
            '5 day ratio': { 
                color: '#8b5cf6', // violet-500
                gradientId: 'violetGradient',
                gradientColors: ['#c4b5fd', '#8b5cf6'], // violet-300 to violet-500
                category: 'primary', 
                yAxis: 'right', 
                name: '5-Day Ratio' 
            },
            '10 day  ratio ': { 
                color: '#f59e0b', // amber-500
                gradientId: 'amberGradient',
                gradientColors: ['#fcd34d', '#f59e0b'], // amber-300 to amber-500
                category: 'primary', 
                yAxis: 'right', 
                name: '10-Day Ratio' 
            },
            'Number of stocks up 25% plus in a quarter': { 
                color: '#059669', // emerald-600
                gradientId: 'emeraldGradient',
                gradientColors: ['#34d399', '#059669'], // emerald-400 to emerald-600
                category: 'primary', 
                yAxis: 'left', 
                name: 'Stocks Up 25%+ Quarter' 
            },
            'Number of stocks down 25% + in a quarter': { 
                color: '#e11d48', // rose-600
                gradientId: 'roseGradient',
                gradientColors: ['#fb7185', '#e11d48'], // rose-400 to rose-600
                category: 'primary', 
                yAxis: 'left', 
                name: 'Stocks Down 25%+ Quarter' 
            },
            
            // Secondary Breadth Indicators - Sky/Orange theme
            'Number of stocks up 25% + in a month': { 
                color: '#0ea5e9', // sky-500
                gradientId: 'skyGradient',
                fillGradientId: 'skyFill',
                gradientColors: ['#7dd3fc', '#0ea5e9'], // sky-300 to sky-500
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Up 25%+ Month' 
            },
            'Number of stocks down 25% + in a month': { 
                color: '#dc2626', // red-600
                gradientId: 'redGradient',
                gradientColors: ['#f87171', '#dc2626'], // red-400 to red-600
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Down 25%+ Month' 
            },
            'Number of stocks up 50% + in a month': { 
                color: '#0284c7', // sky-600
                gradientId: 'skyGradient',
                gradientColors: ['#38bdf8', '#0284c7'], // sky-400 to sky-600
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Up 50%+ Month' 
            },
            'Number of stocks down 50% + in a month': { 
                color: '#b91c1c', // red-700
                gradientId: 'redGradient',
                gradientColors: ['#ef4444', '#b91c1c'], // red-500 to red-700
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Down 50%+ Month' 
            },
            'Number of stocks up 13% + in 34 days': { 
                color: '#0369a1', // sky-700
                gradientId: 'skyGradient',
                gradientColors: ['#0ea5e9', '#0369a1'], // sky-500 to sky-700
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Up 13%+ (34d)' 
            },
            'Number of stocks down 13% + in 34 days': { 
                color: '#991b1b', // red-800
                gradientId: 'redGradient',
                gradientColors: ['#dc2626', '#991b1b'], // red-600 to red-800
                category: 'secondary', 
                yAxis: 'left', 
                name: 'Stocks Down 13%+ (34d)' 
            },
            
            // Market Indicators - Special styling
            'T2108': { 
                color: '#ea580c', // orange-600
                gradientId: 'orangeGradient',
                gradientColors: ['#fb923c', '#ea580c'], // orange-400 to orange-600
                category: 'market', 
                yAxis: 'right', 
                name: 'T2108 (%)', 
                dashArray: [8, 4] // Modern dash pattern
            },
            'S&P': { 
                color: '#6366f1', // indigo-500
                gradientId: 'indigoGradient',
                gradientColors: ['#a5b4fc', '#6366f1'], // indigo-300 to indigo-500
                category: 'market', 
                yAxis: 'right', 
                name: 'S&P 500', 
                dashArray: [12, 6] // Modern dash pattern
            },
            ' Worden Common stock universe': { 
                color: '#65a30d', // lime-600
                gradientId: 'limeGradient',
                gradientColors: ['#a3e635', '#65a30d'], // lime-400 to lime-600
                category: 'market', 
                yAxis: 'left', 
                name: 'Total Universe' 
            }
        };

        // Generate hash for data comparison
        function generateDataHash(data) {
            if (!data || data.length === 0) return null;
            const firstRow = data[0];
            const hashString = JSON.stringify({
                date: firstRow.Date,
                upStocks: firstRow['Number of stocks up 4% plus today'],
                downStocks: firstRow['Number of stocks down 4% plus today'],
                t2108: firstRow['T2108'],
                recordCount: data.length
            });
            return btoa(hashString); // Simple base64 hash
        }

        // Check for fresh data from Google Sheets
        async function checkForFreshData() {
            try {
                updateDataStatus('checking', 'Checking for updates...');
                
                // Fetch directly from Google Sheets CSV
                // Try export URL which should work better for freshness checks
                const response = await fetch('https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv&t=' + Date.now());
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                // Parse just enough to get the latest data point
                const headers = lines[1].split(',');
                const latestRow = {};
                
                if (lines.length > 2) {
                    const values = lines[2].split(',');
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if (value && header !== 'Date') {
                            value = value.replace(/[",]/g, '');
                            if (!isNaN(value) && value !== '') {
                                value = parseFloat(value);
                            }
                        }
                        latestRow[header] = value;
                    });
                }
                
                // Generate hash for comparison
                const newDataHash = generateDataHash([latestRow]);
                lastCheckTime = new Date();
                
                if (lastDataHash === null) {
                    lastDataHash = newDataHash;
                    updateDataStatus('current', 'Data loaded');
                    return { hasUpdate: false, isFirstLoad: true };
                } else if (newDataHash !== lastDataHash) {
                    lastDataHash = newDataHash;
                    updateDataStatus('updated', 'New data available!');
                    return { hasUpdate: true, latestData: latestRow };
                } else {
                    updateDataStatus('current', 'Data is current');
                    return { hasUpdate: false };
                }
                
            } catch (error) {
                console.error('Error checking for fresh data:', error);
                updateDataStatus('error', 'Check failed');
                return { hasUpdate: false, error: true };
            }
        }

        // Update data status display
        function updateDataStatus(status, message) {
            const statusElement = document.getElementById('data-status');
            const lastCheckElement = document.getElementById('last-check');
            
            // Update status badge
            statusElement.textContent = message;
            statusElement.className = 'px-2 py-1 rounded text-xs ';
            
            switch (status) {
                case 'checking':
                    statusElement.className += 'bg-yellow-200 text-yellow-800';
                    break;
                case 'current':
                    statusElement.className += 'bg-green-200 text-green-800';
                    break;
                case 'updated':
                    statusElement.className += 'bg-blue-200 text-blue-800';
                    break;
                case 'error':
                    statusElement.className += 'bg-red-200 text-red-800';
                    break;
                default:
                    statusElement.className += 'bg-gray-200 text-gray-600';
            }
            
            // Update last check time
            if (lastCheckTime) {
                lastCheckElement.textContent = `Last: ${lastCheckTime.toLocaleTimeString()}`;
            }
        }

        // Load and parse CSV data (enhanced version)
        async function loadMarketData(skipFreshCheck = false) {
            try {
                
                document.getElementById('loading-spinner').style.display = 'block';
                
                // Check for fresh data first (unless skipped)
                if (!skipFreshCheck) {
                    const freshCheck = await checkForFreshData();
                    if (!freshCheck.hasUpdate && !freshCheck.isFirstLoad && !freshCheck.error) {
                        document.getElementById('loading-spinner').style.display = 'none';
                        return; // No update needed
                    }
                }
                
                // Try multiple URLs to handle redirects and access issues
                let response;
                const urls = [
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv&t=${Date.now()}`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv&t=${Date.now()}`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv`
                ];
                
                let csvText = '';
                for (let i = 0; i < urls.length; i++) {
                    try {
                        response = await fetch(urls[i]);
                        csvText = await response.text();
                        
                        // Check if we got HTML (redirect page) or actual CSV
                        if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<HTML>')) {
                            continue;
                        }
                        
                        // Check if we got valid CSV data
                        if (csvText.includes('Date,Number of stocks') || csvText.includes('Primary Breadth') || csvText.includes('Date,')) {
                            break;
                        }
                    } catch (error) {
                    }
                }
                
                if (!csvText || csvText.includes('<!DOCTYPE html>') || csvText.includes('<HTML>')) {
                    throw new Error('Could not fetch valid CSV data from Google Sheets. Check console for details.');
                }
                
                
                const lines = csvText.trim().split('\n');
                
                // Skip header rows and parse data
                
                // Parse CSV properly handling quoted values
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    return result;
                }
                
                const headers = parseCSVLine(lines[1]);
                const data = [];
                
                for (let i = 2; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= headers.length && values[0]) {
                        const row = {};
                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (value && header !== 'Date') {
                                // Remove quotes and commas from numbers
                                value = value.replace(/[",]/g, '');
                                if (!isNaN(value) && value !== '') {
                                    value = parseFloat(value);
                                }
                            }
                            row[header] = value;
                        });
                        
                        // Parse date
                        if (row.Date) {
                            row.parsedDate = new Date(row.Date);
                        }
                        
                        data.push(row);
                    }
                }
                
                // Sort data by date (most recent first)
                marketData = data.sort((a, b) => {
                    const dateA = new Date(a.Date);
                    const dateB = new Date(b.Date);
                    return dateB - dateA; // Descending order (newest first)
                });
                
                lastDataHash = generateDataHash(marketData);
                
                
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('current', 'Data refreshed');
                updateDataInfo();
                createIndicatorCheckboxes();
                drawChart();
                updateCurrentReadings();
                
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('error', 'Load failed');
                alert('Error loading market data. Please check your connection and Google Sheets permissions.');
            }
        }

        // Toggle auto-refresh functionality
        function toggleAutoRefresh() {
            const toggleButton = document.getElementById('auto-refresh-toggle');
            
            if (autoRefreshEnabled) {
                // Disable auto-refresh
                autoRefreshEnabled = false;
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                toggleButton.textContent = 'Auto: OFF';
                toggleButton.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700';
            } else {
                // Enable auto-refresh
                autoRefreshEnabled = true;
                toggleButton.textContent = 'Auto: ON';
                toggleButton.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
                
                // Check every 2 minutes
                autoRefreshInterval = setInterval(async () => {
                    const freshCheck = await checkForFreshData();
                    if (freshCheck.hasUpdate) {
                        await loadMarketData(true); // Skip fresh check since we just did it
                    }
                }, 120000); // 2 minutes
                
                // Do initial check
                checkForFreshData();
            }
        }

        // Create indicator selection checkboxes
        function createIndicatorCheckboxes() {
            const primaryContainer = document.getElementById('primary-indicators');
            const secondaryContainer = document.getElementById('secondary-indicators');
            const marketContainer = document.getElementById('market-indicators');
            
            // Clear existing checkboxes to prevent duplicates
            primaryContainer.innerHTML = '';
            secondaryContainer.innerHTML = '';
            marketContainer.innerHTML = '';
            
            Object.entries(indicatorConfig).forEach(([key, config]) => {
                const container = config.category === 'primary' ? primaryContainer :
                                config.category === 'secondary' ? secondaryContainer : marketContainer;
                
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = key;
                checkbox.className = 'indicator-checkbox';
                checkbox.checked = selectedIndicators.has(key);
                
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedIndicators.add(key);
                    } else {
                        selectedIndicators.delete(key);
                    }
                    drawChart();
                });
                
                const label = document.createElement('label');
                label.htmlFor = key;
                label.className = 'text-sm text-gray-700 cursor-pointer flex items-center';
                
                const colorBox = document.createElement('span');
                colorBox.className = 'w-3 h-3 rounded mr-2';
                colorBox.style.backgroundColor = config.color;
                
                label.appendChild(colorBox);
                label.appendChild(document.createTextNode(config.name));
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // Update data information display
        function updateDataInfo() {
            if (marketData.length > 0) {
                // Find the most recent valid date
                let latestDate = null;
                for (let i = 0; i < Math.min(marketData.length, 5); i++) {
                    if (marketData[i].Date) {
                        latestDate = marketData[i].Date;
                        break;
                    }
                }
                
                const oldestDate = marketData[marketData.length - 1].Date;
                
                document.getElementById('last-update').textContent = latestDate || 'Unknown';
                document.getElementById('total-records').textContent = marketData.length.toLocaleString();
                
                // Add date range info if we have multiple records
                if (marketData.length > 1) {
                    const rangeInfo = document.getElementById('date-range');
                    if (rangeInfo) {
                        rangeInfo.textContent = `${oldestDate} - ${latestDate}`;
                    }
                }
            }
        }

        // Update current readings
        function updateCurrentReadings() {
            if (marketData.length === 0) return;
            
            // Use the same data source as the chart: get unfiltered data in chronological order
            const chronologicalData = marketData.slice().reverse(); // Oldest to newest
            const latest = chronologicalData[chronologicalData.length - 1]; // Get the most recent
            
            if (!latest || !latest.Date) {
                return;
            }
            const container = document.getElementById('current-readings');
            
            const dataSource = latest;
            const readings = [
                { label: 'Stocks Up 4%+', value: dataSource['Number of stocks up 4% plus today'], format: 'number' },
                { label: 'Stocks Down 4%+', value: dataSource['Number of stocks down 4% plus today'], format: 'number' },
                { label: '5-Day Ratio', value: dataSource['5 day ratio'], format: 'decimal' },
                { label: 'T2108', value: dataSource['T2108'], format: 'percent' },
                { label: 'S&P 500', value: dataSource['S&P'], format: 'number' }
            ];
            
            container.innerHTML = readings.map(reading => {
                let displayValue = '--';
                if (reading.value !== undefined && reading.value !== null) {
                    if (reading.format === 'number') {
                        displayValue = reading.value.toLocaleString();
                    } else if (reading.format === 'decimal') {
                        displayValue = reading.value.toFixed(2);
                    } else if (reading.format === 'percent') {
                        displayValue = reading.value.toFixed(1) + '%';
                    }
                }
                
                return `
                    <div class="flex justify-between">
                        <span>${reading.label}:</span>
                        <span class="font-semibold">${displayValue}</span>
                    </div>
                `;
            }).join('');
            
            // Update market stats
            const statsContainer = document.getElementById('market-stats');
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            
            statsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span>Trend:</span>
                    <span class="${ratio5day > 1.5 ? 'text-green-600' : ratio5day < 0.8 ? 'text-red-600' : 'text-yellow-600'}">${ratio5day > 1.5 ? 'Bullish' : ratio5day < 0.8 ? 'Bearish' : 'Neutral'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Breadth:</span>
                    <span class="${upStocks > downStocks ? 'text-green-600' : 'text-red-600'}">${upStocks > downStocks ? 'Positive' : 'Negative'}</span>
                </div>
                <div class="flex justify-between">
                    <span>T2108 Level:</span>
                    <span class="${t2108 > 60 ? 'text-green-600' : t2108 < 30 ? 'text-red-600' : 'text-yellow-600'}">${t2108 > 60 ? 'Strong' : t2108 < 30 ? 'Weak' : 'Neutral'}</span>
                </div>
            `;
            
            // Update sentiment
            updateSentiment(latest);
        }

        // Update market sentiment
        function updateSentiment(latest) {
            const sentimentText = document.getElementById('sentiment-text');
            const sentimentDesc = document.getElementById('sentiment-desc');
            
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            
            let sentiment = 'Neutral';
            let color = '#f59e0b';
            let description = 'Mixed breadth signals';
            
            if (upStocks > 1000 && ratio5day > 2.0) {
                sentiment = 'Extremely Bullish';
                color = '#00C851';
                description = 'Massive breadth thrust in progress';
            } else if (downStocks > 500 && t2108 < 20) {
                sentiment = 'Extremely Bearish';
                color = '#ff4444';
                description = 'Severe selling with oversold conditions';
            } else if (upStocks > 400 && ratio5day > 1.8) {
                sentiment = 'Very Bullish';
                color = '#10b981';
                description = 'Strong positive breadth momentum';
            } else if (downStocks > 300 && ratio5day < 0.7) {
                sentiment = 'Very Bearish';
                color = '#ef4444';
                description = 'Significant selling pressure';
            } else if (ratio5day > 1.3) {
                sentiment = 'Bullish';
                color = '#22c55e';
                description = 'Positive breadth momentum';
            } else if (ratio5day < 0.8) {
                sentiment = 'Bearish';
                color = '#f87171';
                description = 'Negative breadth momentum';
            }
            
            sentimentText.textContent = sentiment;
            sentimentText.style.color = color;
            sentimentDesc.textContent = description;
        }

        // Chart rendering with Chart.js - Fully responsive
        let chartInstance = null;
        let resizeTimeout = null;
        let isDarkTheme = false;
        
        // Theme management
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const body = document.body;
            const tooltipEl = document.getElementById('custom-tooltip');
            const themeButton = document.getElementById('theme-toggle');
            
            if (isDarkTheme) {
                body.classList.add('dark');
                tooltipEl.classList.remove('light');
                tooltipEl.classList.add('dark');
                themeButton.textContent = '☀️';
                themeButton.title = 'Switch to Light Theme';
            } else {
                body.classList.remove('dark');
                tooltipEl.classList.remove('dark');
                tooltipEl.classList.add('light');
                themeButton.textContent = '🌙';
                themeButton.title = 'Switch to Dark Theme';
            }
        }
        
        // Format numeric values for tooltip display
        function formatTooltipValue(value, key) {
            if (value === null || value === undefined) return '--';
            
            // Different formatting for different types of values
            if (key === 'T2108') {
                return value.toFixed(1) + '%';
            } else if (key.includes('ratio')) {
                return value.toFixed(2);
            } else if (key.includes('S&P')) {
                return value.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            } else if (typeof value === 'number' && value > 1000) {
                return value.toLocaleString('en-US');
            } else if (typeof value === 'number') {
                return value.toFixed(0);
            }
            
            return value.toString();
        }
        
        // Update tooltip content with series swatches and formatted values
        function updateTooltipContent(tooltip, dataPoint, dataIndex) {
            const dateEl = document.getElementById('tooltip-date');
            const seriesEl = document.getElementById('tooltip-series');
            const summaryEl = document.getElementById('tooltip-summary');
            
            // Update date
            dateEl.innerHTML = `📅 ${dataPoint.Date}`;
            
            // Clear previous content
            seriesEl.innerHTML = '';
            
            // Add series items with color swatches
            tooltip.dataPoints.forEach((dataPoint, index) => {
                // Find the config by matching dataset label with indicator name
                const configKey = Object.keys(indicatorConfig).find(key => 
                    indicatorConfig[key].name === dataPoint.dataset.label
                );
                const config = configKey ? indicatorConfig[configKey] : null;
                
                if (config) {
                    const seriesItem = document.createElement('div');
                    seriesItem.className = 'tooltip-series-item';
                    
                    seriesItem.innerHTML = `
                        <div class="series-info">
                            <div class="series-swatch" style="background-color: ${config.color}"></div>
                            <span class="series-name">${config.name}</span>
                        </div>
                        <span class="series-value">${formatTooltipValue(dataPoint.parsed.y, config.name)}</span>
                    `;
                    
                    seriesEl.appendChild(seriesItem);
                }
            });
            
            // Add market summary
            const upStocks = dataPoint['Number of stocks up 4% plus today'];
            const downStocks = dataPoint['Number of stocks down 4% plus today'];
            const ratio5day = dataPoint['5 day ratio'];
            const t2108 = dataPoint['T2108'];
            
            let summaryHtml = '<div style="font-weight: 600; margin-bottom: 4px;">📊 Market Summary</div>';
            
            if (upStocks !== undefined && downStocks !== undefined) {
                const netBreadth = upStocks - downStocks;
                const netColor = netBreadth > 0 ? '#10b981' : netBreadth < 0 ? '#f43f5e' : '#6b7280';
                summaryHtml += `<div>Net Breadth: <span style="color: ${netColor}; font-weight: 600;">${netBreadth > 0 ? '+' : ''}${netBreadth.toLocaleString()}</span></div>`;
            }
            if (ratio5day !== undefined && ratio5day !== null) {
                const ratioColor = ratio5day > 1.5 ? '#10b981' : ratio5day < 0.8 ? '#f43f5e' : '#f59e0b';
                summaryHtml += `<div>5D Ratio: <span style="color: ${ratioColor}; font-weight: 600;">${ratio5day.toFixed(2)}</span></div>`;
            }
            if (t2108 !== undefined && t2108 !== null) {
                const t2108Color = t2108 > 70 ? '#10b981' : t2108 < 30 ? '#f43f5e' : '#f59e0b';
                summaryHtml += `<div>T2108: <span style="color: ${t2108Color}; font-weight: 600;">${t2108.toFixed(1)}%</span></div>`;
            }
            
            summaryEl.innerHTML = summaryHtml;
        }
        
        // Enhanced chart interactivity management
        let hoveredSeriesIndex = null;
        let crosshairVisible = false;
        
        // Update crosshair region
        function updateCrosshairRegion(chart, tooltip, show = true) {
            const crosshairEl = document.getElementById('crosshair-region');
            const canvas = chart.canvas;
            const canvasRect = canvas.getBoundingClientRect();
            
            if (!show || tooltip.opacity === 0) {
                crosshairEl.classList.remove('show');
                crosshairVisible = false;
                return;
            }
            
            const chartArea = chart.chartArea;
            const x = tooltip.caretX;
            const regionWidth = containerWidth < 640 ? 20 : 30; // Responsive width
            
            // Position the vertical region
            crosshairEl.style.left = (x - regionWidth / 2) + 'px';
            crosshairEl.style.top = chartArea.top + 'px';
            crosshairEl.style.width = regionWidth + 'px';
            crosshairEl.style.height = (chartArea.bottom - chartArea.top) + 'px';
            
            crosshairEl.classList.add('show');
            crosshairVisible = true;
        }
        
        // Animate hover points with scale and pulse effects
        function animateHoverPoints(chart, tooltip, activeElements) {
            // Reset all point animations
            chart.data.datasets.forEach((dataset, datasetIndex) => {
                if (dataset._meta && dataset._meta[chart.id]) {
                    dataset._meta[chart.id].data.forEach((point, pointIndex) => {
                        if (point && point.options) {
                            point.options.radius = point.options.baseRadius || (containerWidth < 640 ? 3 : 4);
                            point.options.hoverRadius = point.options.baseHoverRadius || (containerWidth < 640 ? 6 : 8);
                        }
                    });
                }
            });
            
            // Animate hovered points
            if (activeElements && activeElements.length > 0) {
                activeElements.forEach(element => {
                    const point = element.element;
                    if (point && point.options) {
                        // Store base values if not already stored
                        if (!point.options.baseRadius) {
                            point.options.baseRadius = point.options.radius;
                            point.options.baseHoverRadius = point.options.hoverRadius;
                        }
                        
                        // Animated scaling
                        point.options.radius = (point.options.baseRadius * 1.5);
                        point.options.hoverRadius = (point.options.baseHoverRadius * 1.3);
                        point.options.borderWidth = 3;
                        point.options.hoverBorderWidth = 4;
                    }
                });
            }
        }
        
        // Manage series emphasis and dimming
        function updateSeriesEmphasis(chart, activeElements) {
            if (!activeElements || activeElements.length === 0) {
                // No active elements - reset all series
                chart.data.datasets.forEach((dataset, index) => {
                    const meta = chart.getDatasetMeta(index);
                    if (meta && meta.$context && meta.$context.element) {
                        meta.$context.element.options.borderWidth = dataset.borderWidth || 2;
                        meta.$context.element.options.borderColor = dataset.borderColor;
                        meta.$context.element.options.backgroundColor = dataset.backgroundColor;
                    }
                });
                hoveredSeriesIndex = null;
                return;
            }
            
            const activeDatasetIndex = activeElements[0].datasetIndex;
            
            // Only update if hovering a different series
            if (hoveredSeriesIndex === activeDatasetIndex) return;
            hoveredSeriesIndex = activeDatasetIndex;
            
            chart.data.datasets.forEach((dataset, index) => {
                const meta = chart.getDatasetMeta(index);
                if (meta && meta.$context) {
                    if (index === activeDatasetIndex) {
                        // Emphasize active series
                        dataset._originalBorderWidth = dataset._originalBorderWidth || dataset.borderWidth;
                        dataset.borderWidth = (dataset._originalBorderWidth * 1.5);
                        
                        // Add glow effect by manipulating colors
                        if (dataset.borderColor && typeof dataset.borderColor === 'string') {
                            dataset._glowColor = dataset.borderColor;
                        }
                    } else {
                        // Dim non-active series
                        dataset.borderWidth = (dataset._originalBorderWidth || dataset.borderWidth) * 0.7;
                        
                        // Reduce opacity for non-hovered series
                        if (dataset.borderColor && typeof dataset.borderColor === 'string') {
                            dataset.borderColor = dataset.borderColor + '60'; // Add transparency
                        }
                        if (dataset.backgroundColor && typeof dataset.backgroundColor === 'string') {
                            dataset.backgroundColor = dataset.backgroundColor + '40'; // More transparent
                        }
                    }
                }
            });
            
            // Trigger chart update
            chart.update('none'); // Update without animation for smooth interaction
        }
        
        // Reset series emphasis when leaving chart
        function resetSeriesEmphasis(chart) {
            chart.data.datasets.forEach((dataset, index) => {
                if (dataset._originalBorderWidth) {
                    dataset.borderWidth = dataset._originalBorderWidth;
                }
                
                // Restore original colors
                Object.entries(indicatorConfig).forEach(([key, config]) => {
                    if (config.name === dataset.label) {
                        dataset.borderColor = dataset._originalBorderGradient || config.color;
                        dataset.backgroundColor = dataset._originalBackgroundGradient || (config.color + '20');
                    }
                });
            });
            
            hoveredSeriesIndex = null;
            chart.update('none');
        }
        
        // Intelligent tooltip positioning to avoid clipping
        function positionTooltip(tooltipEl, chart, tooltip) {
            const canvas = chart.canvas;
            const canvasRect = canvas.getBoundingClientRect();
            const tooltipRect = tooltipEl.getBoundingClientRect();
            const arrow = tooltipEl.querySelector('.tooltip-arrow');
            
            let left = canvasRect.left + tooltip.caretX;
            let top = canvasRect.top + tooltip.caretY;
            
            // Check for right edge clipping
            if (left + tooltipRect.width > window.innerWidth - 20) {
                left = canvasRect.left + tooltip.caretX - tooltipRect.width;
            }
            
            // Check for left edge clipping
            if (left < 20) {
                left = 20;
            }
            
            // Check for top edge clipping
            if (top - tooltipRect.height < 20) {
                // Position below the point
                top = canvasRect.top + tooltip.caretY + 20;
                arrow.className = 'tooltip-arrow top';
            } else {
                // Position above the point (default)
                top = canvasRect.top + tooltip.caretY - tooltipRect.height - 10;
                arrow.className = 'tooltip-arrow bottom';
            }
            
            // Check for bottom edge clipping
            if (top + tooltipRect.height > window.innerHeight - 20) {
                top = window.innerHeight - tooltipRect.height - 20;
            }
            
            // Apply positioning
            tooltipEl.style.left = left + 'px';
            tooltipEl.style.top = top + 'px';
            
            // Center arrow horizontally relative to the caret
            const arrowLeft = Math.max(16, Math.min(tooltipRect.width - 16, 
                (canvasRect.left + tooltip.caretX) - left
            ));
            arrow.style.left = arrowLeft + 'px';
            arrow.style.transform = 'translateX(-50%)';
        }
        
        function getResponsiveChartOptions(timeRange, rangeText, containerWidth) {
            // Determine legend position based on container width
            const legendPosition = containerWidth < 640 ? 'bottom' : 'top';
            const legendAlign = containerWidth < 640 ? 'center' : 'start';
            
            // Adjust font sizes based on screen size
            const titleFontSize = containerWidth < 640 ? 12 : 14;
            const legendFontSize = containerWidth < 640 ? 10 : 12;
            const axisFontSize = containerWidth < 640 ? 9 : 11;
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: window.devicePixelRatio || 1,
                interaction: { 
                    mode: "index", 
                    intersect: false,
                    axis: 'x'
                },
                animation: {
                    duration: containerWidth < 640 ? 200 : 300 // Faster animations on mobile
                },
                parsing: {
                    xAxisKey: 'x',
                    yAxisKey: 'y'
                },
                decimation: {
                    enabled: true,
                    algorithm: 'lttb', // Largest Triangle Three Buckets algorithm
                    samples: containerWidth < 640 ? 50 : 100, // Fewer samples on mobile
                    threshold: 1000 // Only apply decimation if dataset has more than 1000 points
                },
                plugins: {
                    legend: { 
                        display: true,
                        position: legendPosition,
                        align: legendAlign,
                        labels: {
                            font: { size: legendFontSize },
                            usePointStyle: true,
                            boxWidth: containerWidth < 640 ? 8 : 12,
                            padding: containerWidth < 640 ? 10 : 15
                        }
                    },
                    title: { 
                        display: true, 
                        text: `📅 ${rangeText}`,
                        font: { 
                            size: titleFontSize,
                            weight: 'bold'
                        },
                        padding: containerWidth < 640 ? 10 : 15
                    },
                    tooltip: {
                        enabled: false, // Disable default tooltip
                        external: function(context) {
                            // Enhanced custom tooltip with animations and interactivity
                            console.log('Tooltip external function called');
                            const tooltipEl = document.getElementById('custom-tooltip');
                            const chart = context.chart;
                            const tooltip = context.tooltip;
                            const activeElements = chart.getActiveElements();
                            
                            console.log('Tooltip opacity:', tooltip.opacity);
                            console.log('Active elements:', activeElements);
                            console.log('Chart filteredData:', chart.filteredData);
                            
                            // Hide tooltip and reset interactions when no data
                            if (tooltip.opacity === 0) {
                                tooltipEl.classList.remove('show');
                                tooltipEl.classList.add('fade-out');
                                updateCrosshairRegion(chart, tooltip, false);
                                resetSeriesEmphasis(chart);
                                setTimeout(() => {
                                    tooltipEl.style.opacity = '0';
                                    tooltipEl.style.pointerEvents = 'none';
                                }, 200);
                                return;
                            }
                            
                            // Show tooltip with animation
                            tooltipEl.style.opacity = '1';
                            tooltipEl.style.pointerEvents = 'none';
                            tooltipEl.classList.remove('fade-out');
                            tooltipEl.classList.add('slide-in', 'show');
                            
                            // Update crosshair region
                            updateCrosshairRegion(chart, tooltip, true);
                            
                            // Animate hover points
                            animateHoverPoints(chart, tooltip, activeElements);
                            
                            // Update series emphasis
                            updateSeriesEmphasis(chart, activeElements);
                            
                            // Get data point
                            console.log('Tooltip dataPoints:', tooltip.dataPoints);
                            const dataIndex = tooltip.dataPoints[0].dataIndex;
                            console.log('Data index:', dataIndex);
                            const dataPoint = chart.filteredData[dataIndex];
                            console.log('Data point:', dataPoint);
                            
                            if (dataPoint) {
                                // Update tooltip content
                                updateTooltipContent(tooltip, dataPoint, dataIndex);
                                
                                // Intelligent positioning
                                positionTooltip(tooltipEl, chart, tooltip);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: containerWidth >= 640, // Hide grid on mobile for cleaner look
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            maxTicksLimit: containerWidth < 640 ? 4 : containerWidth < 1024 ? 6 : 8,
                            callback: function(value, index, values) {
                                // Format dates based on screen size
                                const date = new Date(this.getLabelForValue(value));
                                if (containerWidth < 640) {
                                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                }
                                return this.getLabelForValue(value);
                            }
                        }
                    },
                    y: { 
                        type: "linear", 
                        position: "left",
                        display: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            callback: function(value) {
                                // Format large numbers
                                if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + 'K';
                                }
                                return value.toLocaleString();
                            }
                        }
                    },
                    y1: { 
                        type: "linear", 
                        position: "right",
                        display: containerWidth >= 768, // Hide right axis on small screens
                        grid: { 
                            drawOnChartArea: false,
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            callback: function(value) {
                                return value.toFixed(1);
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: containerWidth < 640 ? 3 : 4,
                        hoverRadius: containerWidth < 640 ? 8 : 12,
                        hitRadius: containerWidth < 640 ? 12 : 16,
                        borderWidth: containerWidth < 640 ? 2 : 3,
                        hoverBorderWidth: containerWidth < 640 ? 3 : 4,
                        pointStyle: 'circle',
                        // Enhanced hover animation properties
                        hoverBackgroundColor: function(context) {
                            return context.element.options.backgroundColor;
                        },
                        hoverBorderColor: '#ffffff'
                    },
                    line: {
                        borderWidth: containerWidth < 640 ? 2 : 3,
                        tension: 0.4, // Smooth curves
                        borderJoinStyle: 'round',
                        borderCapStyle: 'round',
                        // Enhanced hover effects
                        hoverBorderWidth: function(context) {
                            return (context.dataset.borderWidth || 3) * 1.3;
                        }
                    }
                },
                // Enhanced animations for smoother interactions
                animation: {
                    duration: 300,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure crosshair is properly positioned after animation
                        if (crosshairVisible && this.tooltip && this.tooltip.opacity > 0) {
                            updateCrosshairRegion(this, this.tooltip, true);
                        }
                    }
                },
                animations: {
                    // Smooth property animations
                    radius: {
                        duration: 200,
                        easing: 'easeOutBack'
                    },
                    borderWidth: {
                        duration: 150,
                        easing: 'easeOutQuad'
                    }
                },
                // Enhanced hover interactions
                interaction: {
                    mode: 'index',
                    intersect: false,
                    axis: 'x',
                    includeInvisible: false
                },
                // Enhanced chart area styling
                layout: {
                    padding: {
                        left: containerWidth < 640 ? 10 : 20,
                        right: containerWidth < 640 ? 10 : 20,
                        top: containerWidth < 640 ? 10 : 20,
                        bottom: containerWidth < 640 ? 10 : 20
                    }
                }
            };
        }
        

        function drawChart() {
            if (marketData.length === 0) return;

            const canvas = document.getElementById('stockChart');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Set canvas size to match container
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            
            const timeRange = parseInt(document.getElementById('time-range').value);

            let filteredData = marketData;
            if (timeRange > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - timeRange);
                filteredData = marketData.filter(d => {
                    if (!d.Date) return false;
                    return new Date(d.Date) >= cutoffDate;
                });
            }
            if (filteredData.length === 0) return;

            // Debug: Check data ordering
            
            // Keep newest-first order so latest date appears on the right
            const orderedData = filteredData.slice(); // No reverse - keep as newest first
            
            
            const labels = orderedData.map(d => {
                // Format labels based on container width
                if (containerWidth < 640) {
                    return new Date(d.Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                return d.Date;
            });

            const activeIndicators = Array.from(selectedIndicators).filter(key =>
                orderedData.some(d => d[key] !== undefined && d[key] !== null)
            );
            if (activeIndicators.length === 0) return;

            // Create datasets with SVG-inspired gradients
            const datasets = activeIndicators.map((key, index) => {
                const config = indicatorConfig[key];
                
                // Create Canvas gradients based on SVG gradient definitions
                let backgroundGradient = null;
                let borderGradient = null;
                
                if (config.gradientColors && config.gradientId) {
                    // Create smooth monotone background gradient (subtle fill)
                    backgroundGradient = ctx.createLinearGradient(0, 0, 0, containerHeight);
                    backgroundGradient.addColorStop(0, config.gradientColors[0] + '60'); // 38% opacity at top
                    backgroundGradient.addColorStop(0.7, config.gradientColors[1] + '30'); // 19% opacity 
                    backgroundGradient.addColorStop(1, config.gradientColors[1] + '10'); // 6% opacity at bottom
                    
                    // Create horizontal gradient for border (matching SVG gradients)
                    borderGradient = ctx.createLinearGradient(0, 0, containerWidth, 0);
                    borderGradient.addColorStop(0, config.gradientColors[0]); // Light color at left
                    borderGradient.addColorStop(0.3, config.color); // Main color
                    borderGradient.addColorStop(0.7, config.color); // Main color
                    borderGradient.addColorStop(1, config.gradientColors[1]); // Dark color at right
                }
                
                return {
                    label: config.name,
                    data: orderedData.map(d => d[key] !== undefined && d[key] !== null ? d[key] : null),
                    borderColor: borderGradient || config.color,
                    backgroundColor: backgroundGradient || (config.color + '20'),
                    borderDash: config.dashArray || undefined,
                    yAxisID: containerWidth >= 768 && config.yAxis === 'right' ? 'y1' : 'y',
                    
                    // Enhanced smoothing and styling
                    tension: 0.4, // Increased for smoother curves (monotone-like effect)
                    cubicInterpolationMode: 'monotone', // Smooth monotone interpolation
                    spanGaps: true,
                    fill: backgroundGradient ? 'origin' : false, // Enable subtle gradient fill
                    
                    // Modern point styling
                    pointBackgroundColor: config.color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: containerWidth < 640 ? 2 : 3,
                    pointRadius: containerWidth < 640 ? 3 : 4,
                    pointHoverRadius: containerWidth < 640 ? 5 : 7,
                    pointHoverBorderWidth: 3,
                    
                    // Enhanced line styling
                    borderWidth: containerWidth < 640 ? 2 : 3,
                    borderJoinStyle: 'round', // Rounded line joins
                    borderCapStyle: 'round'  // Rounded line caps
                };
            });

            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }

            const rangeText = timeRange > 0
                ? `${filteredData[0].Date} to ${filteredData[filteredData.length - 1].Date}`
                : "All Historical Data";

            // Create new chart with responsive options using the selected indicators
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: getResponsiveChartOptions(timeRange, rangeText, containerWidth)
            });
            
            // Store filtered data on chart instance for tooltip access
            chartInstance.filteredData = filteredData;
            
            // Add enhanced mouse interaction event listeners
            canvas.addEventListener('mouseleave', function() {
                // Clean up interactions when mouse leaves chart
                const crosshairEl = document.getElementById('crosshair-region');
                crosshairEl.classList.remove('show');
                crosshairVisible = false;
                resetSeriesEmphasis(chartInstance);
            });
            
            canvas.addEventListener('mouseenter', function() {
                // Prepare for interactions when mouse enters chart
                canvas.style.cursor = 'crosshair';
            });
        }
        
        // Optimized resize handler
        function handleResize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            
            resizeTimeout = setTimeout(() => {
                if (chartInstance) {
                    // Force redraw with new responsive settings
                    drawChart();
                }
            }, 250); // Debounce resize events
        }

        // Event listeners
        document.getElementById('time-range').addEventListener('change', drawChart);
        document.getElementById('refresh-data').addEventListener('click', () => loadMarketData(true));
        document.getElementById('auto-refresh-toggle').addEventListener('click', toggleAutoRefresh);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMarketData();
            
            // Set up periodic freshness checks (every 5 minutes when auto-refresh is off)
            setInterval(async () => {
                if (!autoRefreshEnabled) {
                    await checkForFreshData();
                }
            }, 300000); // 5 minutes
        });
        
        // Responsive resize handling
        window.addEventListener('resize', handleResize);
        
        // Handle orientation change on mobile devices
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 100); // Small delay to account for orientation change
        });
    </script>
    -->
</body>
</html>

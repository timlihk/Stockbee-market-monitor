<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockbee Market Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background-color: #f9fafb;
        }
        .chart-line {
            fill: none;
            stroke-width: 2;
        }
        .grid-line {
            stroke: #e5e7eb;
            stroke-width: 1;
            stroke-dasharray: 3,3;
        }
        .axis-line {
            stroke: #6b7280;
            stroke-width: 1;
        }
        .axis-text {
            font-size: 12px;
            fill: #6b7280;
            font-family: inherit;
        }
        .chart-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
        }
        .hover-area {
            fill: transparent;
            cursor: crosshair;
        }
        .hover-line {
            stroke: #6b7280;
            stroke-width: 1;
            stroke-dasharray: 2,2;
            pointer-events: none;
            opacity: 0.7;
        }
        .hover-point {
            fill: white;
            stroke-width: 2;
            pointer-events: none;
        }
        .indicator-checkbox {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        .indicator-checkbox:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .indicator-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 10px;
            top: -1px;
            left: 2px;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="p-6 bg-gray-50 min-h-screen">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Stockbee Market Monitor</h1>
                            <p class="text-gray-600 mt-2">Real-time breadth analysis with customizable indicators</p>
                        </div>
                        <div class="text-right mt-4 lg:mt-0" id="sentiment-display">
                            <div class="text-lg font-semibold" id="sentiment-text">Loading...</div>
                            <div class="text-sm text-gray-500" id="sentiment-desc">Analyzing live market data</div>
                        </div>
                    </div>
                    
                    <!-- Indicator Selection Panel -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">Select Indicators to Display</h3>
                            <div class="flex items-center gap-2">
                                <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                                <button id="refresh-data" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    Refresh Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Primary Breadth Indicators</h4>
                                <div class="space-y-2" id="primary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Secondary Breadth Indicators</h4>
                                <div class="space-y-2" id="secondary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Market Indicators</h4>
                                <div class="space-y-2" id="market-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 mt-4">
                            <label class="text-sm text-gray-600">
                                Time Range:
                                <select id="time-range" class="ml-2 px-3 py-1 border border-gray-300 rounded">
                                    <option value="30">Last 30 days</option>
                                    <option value="60" selected>Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="180">Last 6 months</option>
                                    <option value="0">All data</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white rounded-lg border">
                        <svg id="stockChart" width="100%" height="500" viewBox="0 0 1000 500">
                            <!-- Chart will be drawn here -->
                        </svg>
                        <div class="chart-tooltip" id="tooltip"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Current Readings</h3>
                        <div class="space-y-2 text-sm" id="current-readings">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Key Levels</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>T2108 &lt; 20:</span>
                                <span class="text-green-600">Oversold</span>
                            </div>
                            <div class="flex justify-between">
                                <span>5-Day Ratio &gt; 2.0:</span>
                                <span class="text-green-600">Breadth Thrust</span>
                            </div>
                            <div class="flex justify-between">
                                <span>4% Down &gt; 300:</span>
                                <span class="text-red-600">High Selling</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Up 4% &gt; 1000:</span>
                                <span class="text-green-600">Extreme Buying</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Market Stats</h3>
                        <div class="space-y-2 text-sm" id="market-stats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Data Info</h3>
                        <div class="space-y-2 text-sm" id="data-info">
                            <div class="flex justify-between">
                                <span>Last Update:</span>
                                <span id="last-update">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Records:</span>
                                <span id="total-records">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data Source:</span>
                                <span class="text-blue-600">Google Sheets</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <div class="flex items-center">
                        <div class="text-blue-600 mr-3">📊</div>
                        <div>
                            <h4 class="font-medium text-blue-800">Live Data Integration</h4>
                            <p class="text-sm text-blue-700 mt-1">Charts display real market breadth data from your Google Sheets. Use the indicator checkboxes above to customize your view.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let marketData = [];
        let selectedIndicators = new Set(['Number of stocks up 4% plus today', 'Number of stocks down 4% plus today', 'T2108']);
        
        // Define indicator configurations
        const indicatorConfig = {
            // Primary Breadth Indicators
            'Number of stocks up 4% plus today': { color: '#00C851', category: 'primary', yAxis: 'left', name: 'Stocks Up 4%+' },
            'Number of stocks down 4% plus today': { color: '#ff4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 4%+' },
            '5 day ratio': { color: '#8b5cf6', category: 'primary', yAxis: 'right', name: '5-Day Ratio' },
            '10 day  ratio ': { color: '#f59e0b', category: 'primary', yAxis: 'right', name: '10-Day Ratio' },
            'Number of stocks up 25% plus in a quarter': { color: '#10b981', category: 'primary', yAxis: 'left', name: 'Stocks Up 25%+ Quarter' },
            'Number of stocks down 25% + in a quarter': { color: '#ef4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 25%+ Quarter' },
            
            // Secondary Breadth Indicators
            'Number of stocks up 25% + in a month': { color: '#06b6d4', category: 'secondary', yAxis: 'left', name: 'Stocks Up 25%+ Month' },
            'Number of stocks down 25% + in a month': { color: '#dc2626', category: 'secondary', yAxis: 'left', name: 'Stocks Down 25%+ Month' },
            'Number of stocks up 50% + in a month': { color: '#16a34a', category: 'secondary', yAxis: 'left', name: 'Stocks Up 50%+ Month' },
            'Number of stocks down 50% + in a month': { color: '#b91c1c', category: 'secondary', yAxis: 'left', name: 'Stocks Down 50%+ Month' },
            'Number of stocks up 13% + in 34 days': { color: '#0ea5e9', category: 'secondary', yAxis: 'left', name: 'Stocks Up 13%+ (34d)' },
            'Number of stocks down 13% + in 34 days': { color: '#e11d48', category: 'secondary', yAxis: 'left', name: 'Stocks Down 13%+ (34d)' },
            
            // Market Indicators
            'T2108': { color: '#ff6600', category: 'market', yAxis: 'right', name: 'T2108 (%)', dashArray: '5,5' },
            'S&P': { color: '#6366f1', category: 'market', yAxis: 'right', name: 'S&P 500', dashArray: '10,5' },
            ' Worden Common stock universe': { color: '#84cc16', category: 'market', yAxis: 'left', name: 'Total Universe' }
        };

        // Load and parse CSV data
        async function loadMarketData() {
            try {
                document.getElementById('loading-spinner').style.display = 'block';
                
                const response = await fetch('./market_data.csv');
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                // Skip header rows and parse data
                const headers = lines[1].split(',');
                const data = [];
                
                for (let i = 2; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length && values[0]) {
                        const row = {};
                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (value && header !== 'Date') {
                                // Remove quotes and commas from numbers
                                value = value.replace(/[",]/g, '');
                                if (!isNaN(value) && value !== '') {
                                    value = parseFloat(value);
                                }
                            }
                            row[header] = value;
                        });
                        
                        // Parse date
                        if (row.Date) {
                            row.parsedDate = new Date(row.Date);
                        }
                        
                        data.push(row);
                    }
                }
                
                marketData = data.reverse(); // Most recent first
                
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataInfo();
                createIndicatorCheckboxes();
                drawChart();
                updateCurrentReadings();
                
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('loading-spinner').style.display = 'none';
                alert('Error loading market data. Please check your connection.');
            }
        }

        // Create indicator selection checkboxes
        function createIndicatorCheckboxes() {
            const primaryContainer = document.getElementById('primary-indicators');
            const secondaryContainer = document.getElementById('secondary-indicators');
            const marketContainer = document.getElementById('market-indicators');
            
            // Clear existing checkboxes to prevent duplicates
            primaryContainer.innerHTML = '';
            secondaryContainer.innerHTML = '';
            marketContainer.innerHTML = '';
            
            Object.entries(indicatorConfig).forEach(([key, config]) => {
                const container = config.category === 'primary' ? primaryContainer :
                                config.category === 'secondary' ? secondaryContainer : marketContainer;
                
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = key;
                checkbox.className = 'indicator-checkbox';
                checkbox.checked = selectedIndicators.has(key);
                
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedIndicators.add(key);
                    } else {
                        selectedIndicators.delete(key);
                    }
                    drawChart();
                });
                
                const label = document.createElement('label');
                label.htmlFor = key;
                label.className = 'text-sm text-gray-700 cursor-pointer flex items-center';
                
                const colorBox = document.createElement('span');
                colorBox.className = 'w-3 h-3 rounded mr-2';
                colorBox.style.backgroundColor = config.color;
                
                label.appendChild(colorBox);
                label.appendChild(document.createTextNode(config.name));
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // Update data information display
        function updateDataInfo() {
            if (marketData.length > 0) {
                document.getElementById('last-update').textContent = marketData[0].Date;
                document.getElementById('total-records').textContent = marketData.length.toLocaleString();
            }
        }

        // Update current readings
        function updateCurrentReadings() {
            if (marketData.length === 0) return;
            
            const latest = marketData[0];
            const container = document.getElementById('current-readings');
            
            const readings = [
                { label: 'Stocks Up 4%+', value: latest['Number of stocks up 4% plus today'], format: 'number' },
                { label: 'Stocks Down 4%+', value: latest['Number of stocks down 4% plus today'], format: 'number' },
                { label: '5-Day Ratio', value: latest['5 day ratio'], format: 'decimal' },
                { label: 'T2108', value: latest['T2108'], format: 'percent' },
                { label: 'S&P 500', value: latest['S&P'], format: 'number' }
            ];
            
            container.innerHTML = readings.map(reading => {
                let displayValue = '--';
                if (reading.value !== undefined && reading.value !== null) {
                    if (reading.format === 'number') {
                        displayValue = reading.value.toLocaleString();
                    } else if (reading.format === 'decimal') {
                        displayValue = reading.value.toFixed(2);
                    } else if (reading.format === 'percent') {
                        displayValue = reading.value.toFixed(1) + '%';
                    }
                }
                
                return `
                    <div class="flex justify-between">
                        <span>${reading.label}:</span>
                        <span class="font-semibold">${displayValue}</span>
                    </div>
                `;
            }).join('');
            
            // Update market stats
            const statsContainer = document.getElementById('market-stats');
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            
            statsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span>Trend:</span>
                    <span class="${ratio5day > 1.5 ? 'text-green-600' : ratio5day < 0.8 ? 'text-red-600' : 'text-yellow-600'}">${ratio5day > 1.5 ? 'Bullish' : ratio5day < 0.8 ? 'Bearish' : 'Neutral'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Breadth:</span>
                    <span class="${upStocks > downStocks ? 'text-green-600' : 'text-red-600'}">${upStocks > downStocks ? 'Positive' : 'Negative'}</span>
                </div>
                <div class="flex justify-between">
                    <span>T2108 Level:</span>
                    <span class="${t2108 > 60 ? 'text-green-600' : t2108 < 30 ? 'text-red-600' : 'text-yellow-600'}">${t2108 > 60 ? 'Strong' : t2108 < 30 ? 'Weak' : 'Neutral'}</span>
                </div>
            `;
            
            // Update sentiment
            updateSentiment(latest);
        }

        // Update market sentiment
        function updateSentiment(latest) {
            const sentimentText = document.getElementById('sentiment-text');
            const sentimentDesc = document.getElementById('sentiment-desc');
            
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            
            let sentiment = 'Neutral';
            let color = '#f59e0b';
            let description = 'Mixed breadth signals';
            
            if (upStocks > 1000 && ratio5day > 2.0) {
                sentiment = 'Extremely Bullish';
                color = '#00C851';
                description = 'Massive breadth thrust in progress';
            } else if (downStocks > 500 && t2108 < 20) {
                sentiment = 'Extremely Bearish';
                color = '#ff4444';
                description = 'Severe selling with oversold conditions';
            } else if (upStocks > 400 && ratio5day > 1.8) {
                sentiment = 'Very Bullish';
                color = '#10b981';
                description = 'Strong positive breadth momentum';
            } else if (downStocks > 300 && ratio5day < 0.7) {
                sentiment = 'Very Bearish';
                color = '#ef4444';
                description = 'Significant selling pressure';
            } else if (ratio5day > 1.3) {
                sentiment = 'Bullish';
                color = '#22c55e';
                description = 'Positive breadth momentum';
            } else if (ratio5day < 0.8) {
                sentiment = 'Bearish';
                color = '#f87171';
                description = 'Negative breadth momentum';
            }
            
            sentimentText.textContent = sentiment;
            sentimentText.style.color = color;
            sentimentDesc.textContent = description;
        }

        // SVG Chart Drawing Functions
        function createSVGElement(tag, attrs) {
            const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (const [key, value] of Object.entries(attrs)) {
                el.setAttribute(key, value);
            }
            return el;
        }

        // Draw the main chart
        function drawChart() {
            if (marketData.length === 0) return;
            
            const svg = document.getElementById('stockChart');
            const tooltip = document.getElementById('tooltip');
            const timeRange = parseInt(document.getElementById('time-range').value);
            
            svg.innerHTML = '';
            
            // Filter data by time range
            let filteredData = marketData;
            if (timeRange > 0) {
                filteredData = marketData.slice(0, timeRange);
            }
            
            if (filteredData.length === 0) return;
            
            // Chart dimensions
            const margin = { top: 50, right: 80, bottom: 80, left: 80 };
            const width = 1000 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;
            
            const chartGroup = createSVGElement('g', {
                transform: `translate(${margin.left}, ${margin.top})`
            });
            svg.appendChild(chartGroup);
            
            // Get selected indicator data
            const activeIndicators = Array.from(selectedIndicators).filter(key => 
                filteredData.some(d => d[key] !== undefined && d[key] !== null)
            );
            
            if (activeIndicators.length === 0) return;
            
            // Calculate scales
            const leftAxisIndicators = activeIndicators.filter(key => indicatorConfig[key].yAxis === 'left');
            const rightAxisIndicators = activeIndicators.filter(key => indicatorConfig[key].yAxis === 'right');
            
            let leftMin = 0, leftMax = 100, rightMin = 0, rightMax = 100;
            
            if (leftAxisIndicators.length > 0) {
                const leftValues = filteredData.flatMap(d => 
                    leftAxisIndicators.map(key => d[key]).filter(v => v !== undefined && v !== null)
                );
                leftMin = Math.min(...leftValues);
                leftMax = Math.max(...leftValues);
                const leftPadding = (leftMax - leftMin) * 0.1;
                leftMin = Math.max(0, leftMin - leftPadding);
                leftMax = leftMax + leftPadding;
            }
            
            if (rightAxisIndicators.length > 0) {
                const rightValues = filteredData.flatMap(d => 
                    rightAxisIndicators.map(key => d[key]).filter(v => v !== undefined && v !== null)
                );
                rightMin = Math.min(...rightValues);
                rightMax = Math.max(...rightValues);
                const rightPadding = (rightMax - rightMin) * 0.1;
                rightMin = Math.max(0, rightMin - rightPadding);
                rightMax = rightMax + rightPadding;
            }
            
            const scaleX = (i) => (i / Math.max(filteredData.length - 1, 1)) * width;
            const scaleLeft = (value) => height - ((value - leftMin) / (leftMax - leftMin)) * height;
            const scaleRight = (value) => height - ((value - rightMin) / (rightMax - rightMin)) * height;
            
            // Draw grid lines
            for (let i = 0; i <= 5; i++) {
                const y = (i / 5) * height;
                const gridLine = createSVGElement('line', {
                    x1: '0', y1: y.toString(), x2: width.toString(), y2: y.toString(),
                    class: 'grid-line'
                });
                chartGroup.appendChild(gridLine);
            }
            
            // Draw axes
            [
                { x1: '0', y1: '0', x2: '0', y2: height.toString() },
                { x1: '0', y1: height.toString(), x2: width.toString(), y2: height.toString() },
                { x1: width.toString(), y1: '0', x2: width.toString(), y2: height.toString() }
            ].forEach(attrs => {
                const axis = createSVGElement('line', { ...attrs, class: 'axis-line' });
                chartGroup.appendChild(axis);
            });
            
            // Draw Y-axis labels (left)
            if (leftAxisIndicators.length > 0) {
                for (let i = 0; i <= 5; i++) {
                    const value = leftMin + (leftMax - leftMin) * i / 5;
                    const y = height - (i / 5) * height;
                    const label = createSVGElement('text', {
                        x: '-10', y: (y + 4).toString(),
                        class: 'axis-text', 'text-anchor': 'end'
                    });
                    label.textContent = Math.round(value).toLocaleString();
                    chartGroup.appendChild(label);
                }
            }
            
            // Draw Y-axis labels (right)
            if (rightAxisIndicators.length > 0) {
                for (let i = 0; i <= 5; i++) {
                    const value = rightMin + (rightMax - rightMin) * i / 5;
                    const y = height - (i / 5) * height;
                    const label = createSVGElement('text', {
                        x: (width + 10).toString(), y: (y + 4).toString(),
                        class: 'axis-text', 'text-anchor': 'start'
                    });
                    label.textContent = value.toFixed(1);
                    chartGroup.appendChild(label);
                }
            }
            
            // Draw X-axis labels
            const labelStep = Math.max(1, Math.ceil(filteredData.length / 8));
            for (let i = 0; i < filteredData.length; i += labelStep) {
                const x = scaleX(i);
                const label = createSVGElement('text', {
                    x: x.toString(), y: (height + 25).toString(),
                    class: 'axis-text', 'text-anchor': 'middle'
                });
                label.textContent = new Date(filteredData[i].Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                chartGroup.appendChild(label);
            }
            
            // Draw indicator lines
            activeIndicators.forEach(indicatorKey => {
                const config = indicatorConfig[indicatorKey];
                const scaleFunc = config.yAxis === 'left' ? scaleLeft : scaleRight;
                
                const pathData = filteredData.map((d, i) => {
                    if (d[indicatorKey] === undefined || d[indicatorKey] === null) return null;
                    const x = scaleX(i);
                    const y = scaleFunc(d[indicatorKey]);
                    return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                }).filter(p => p !== null).join(' ');
                
                if (pathData) {
                    const path = createSVGElement('path', {
                        d: pathData,
                        class: 'chart-line',
                        stroke: config.color,
                        'stroke-width': '2',
                        'stroke-dasharray': config.dashArray || 'none'
                    });
                    chartGroup.appendChild(path);
                    
                    // Draw data points
                    filteredData.forEach((d, i) => {
                        if (d[indicatorKey] !== undefined && d[indicatorKey] !== null) {
                            const x = scaleX(i);
                            const y = scaleFunc(d[indicatorKey]);
                            const circle = createSVGElement('circle', {
                                cx: x.toString(), cy: y.toString(), r: '3',
                                fill: config.color, stroke: 'white', 'stroke-width': '1'
                            });
                            chartGroup.appendChild(circle);
                        }
                    });
                }
            });
            
            // Create hover elements
            const hoverLine = createSVGElement('line', {
                x1: '0', y1: '0', x2: '0', y2: height.toString(),
                class: 'hover-line',
                style: 'display: none'
            });
            chartGroup.appendChild(hoverLine);
            
            const hoverPoints = [];
            activeIndicators.forEach(key => {
                const config = indicatorConfig[key];
                const hoverPoint = createSVGElement('circle', {
                    cx: '0', cy: '0', r: '5',
                    class: 'hover-point',
                    stroke: config.color,
                    style: 'display: none'
                });
                hoverPoints.push({ element: hoverPoint, key, config });
                chartGroup.appendChild(hoverPoint);
            });
            
            // Add hover areas for enhanced tooltips
            filteredData.forEach((d, i) => {
                const x = scaleX(i);
                const hoverRect = createSVGElement('rect', {
                    x: (x - 15).toString(), y: '0', width: '30', height: height.toString(),
                    class: 'hover-area'
                });
                
                hoverRect.addEventListener('mouseenter', (e) => {
                    // Show hover line
                    hoverLine.setAttribute('x1', x.toString());
                    hoverLine.setAttribute('x2', x.toString());
                    hoverLine.style.display = 'block';
                    
                    // Show hover points for each active indicator
                    hoverPoints.forEach(({ element, key, config }) => {
                        if (d[key] !== undefined && d[key] !== null) {
                            const scaleFunc = config.yAxis === 'left' ? scaleLeft : scaleRight;
                            const y = scaleFunc(d[key]);
                            element.setAttribute('cx', x.toString());
                            element.setAttribute('cy', y.toString());
                            element.style.display = 'block';
                        } else {
                            element.style.display = 'none';
                        }
                    });
                    
                    // Enhanced tooltip content
                    const tooltipContent = [`<strong>📅 ${d.Date}</strong>`];
                    
                    // Add market summary
                    const upStocks = d['Number of stocks up 4% plus today'];
                    const downStocks = d['Number of stocks down 4% plus today'];
                    const t2108 = d['T2108'];
                    const ratio5day = d['5 day ratio'];
                    
                    if (upStocks !== undefined && downStocks !== undefined) {
                        const netBreadth = upStocks - downStocks;
                        const breadthColor = netBreadth > 0 ? '#10b981' : '#ef4444';
                        tooltipContent.push(`<div style="margin: 8px 0; padding: 4px; background: rgba(0,0,0,0.1); border-radius: 4px;">`);
                        tooltipContent.push(`<strong>📊 Market Summary</strong>`);
                        tooltipContent.push(`Net Breadth: <span style="color: ${breadthColor}">${netBreadth > 0 ? '+' : ''}${netBreadth.toLocaleString()}</span>`);
                        if (ratio5day) tooltipContent.push(`5D Ratio: <strong>${ratio5day.toFixed(2)}</strong>`);
                        if (t2108) tooltipContent.push(`T2108: <strong>${t2108.toFixed(1)}%</strong>`);
                        tooltipContent.push(`</div>`);
                    }
                    
                    // Add selected indicators
                    tooltipContent.push(`<strong>📈 Selected Indicators:</strong>`);
                    activeIndicators.forEach(key => {
                        if (d[key] !== undefined && d[key] !== null) {
                            const config = indicatorConfig[key];
                            let value = d[key];
                            let displayValue;
                            
                            // Format values appropriately
                            if (key === 'T2108') {
                                displayValue = `${value.toFixed(1)}%`;
                            } else if (key === '5 day ratio' || key === '10 day  ratio ') {
                                displayValue = value.toFixed(2);
                            } else if (typeof value === 'number') {
                                displayValue = value.toLocaleString();
                            } else {
                                displayValue = value;
                            }
                            
                            tooltipContent.push(`<span style="color: ${config.color}">●</span> ${config.name}: <strong>${displayValue}</strong>`);
                        }
                    });
                    
                    // Position and show tooltip
                    tooltip.innerHTML = tooltipContent.join('<br>');
                    tooltip.style.display = 'block';
                    
                    // Smart positioning to avoid edge overflow
                    const tooltipRect = tooltip.getBoundingClientRect();
                    let left = e.pageX + 15;
                    let top = e.pageY - 10;
                    
                    if (left + tooltipRect.width > window.innerWidth - 20) {
                        left = e.pageX - tooltipRect.width - 15;
                    }
                    if (top + tooltipRect.height > window.innerHeight - 20) {
                        top = e.pageY - tooltipRect.height - 10;
                    }
                    
                    tooltip.style.left = Math.max(10, left) + 'px';
                    tooltip.style.top = Math.max(10, top) + 'px';
                });
                
                hoverRect.addEventListener('mousemove', (e) => {
                    // Update tooltip position on mouse move
                    const tooltipRect = tooltip.getBoundingClientRect();
                    let left = e.pageX + 15;
                    let top = e.pageY - 10;
                    
                    if (left + tooltipRect.width > window.innerWidth - 20) {
                        left = e.pageX - tooltipRect.width - 15;
                    }
                    if (top + tooltipRect.height > window.innerHeight - 20) {
                        top = e.pageY - tooltipRect.height - 10;
                    }
                    
                    tooltip.style.left = Math.max(10, left) + 'px';
                    tooltip.style.top = Math.max(10, top) + 'px';
                });
                
                hoverRect.addEventListener('mouseleave', () => {
                    // Hide hover elements
                    hoverLine.style.display = 'none';
                    hoverPoints.forEach(({ element }) => {
                        element.style.display = 'none';
                    });
                    tooltip.style.display = 'none';
                });
                
                chartGroup.appendChild(hoverRect);
            });
            
            // Add legend
            const legend = createSVGElement('g', { transform: 'translate(20, 20)' });
            activeIndicators.forEach((key, i) => {
                const config = indicatorConfig[key];
                const legendY = i * 18;
                
                const line = createSVGElement('line', {
                    x1: '0', y1: legendY.toString(), x2: '20', y2: legendY.toString(),
                    stroke: config.color, 'stroke-width': '3',
                    'stroke-dasharray': config.dashArray || 'none'
                });
                
                const text = createSVGElement('text', {
                    x: '25', y: (legendY + 4).toString(),
                    class: 'axis-text', fill: '#374151'
                });
                text.textContent = config.name;
                
                legend.appendChild(line);
                legend.appendChild(text);
            });
            chartGroup.appendChild(legend);
        }

        // Event listeners
        document.getElementById('time-range').addEventListener('change', drawChart);
        document.getElementById('refresh-data').addEventListener('click', loadMarketData);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadMarketData);
        window.addEventListener('resize', drawChart);
    </script>
</body>
</html>
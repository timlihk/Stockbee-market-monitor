<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockbee Market Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background-color: #f9fafb;
        }
        .chart-container {
            position: relative;
        }
        .indicator-checkbox {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        .indicator-checkbox:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .indicator-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 10px;
            top: -1px;
            left: 2px;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="p-6 bg-gray-50 min-h-screen">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Stockbee Market Monitor</h1>
                            <p class="text-gray-600 mt-2">Real-time breadth analysis with customizable indicators</p>
                        </div>
                        <div class="text-right mt-4 lg:mt-0" id="sentiment-display">
                            <div class="text-lg font-semibold" id="sentiment-text">Loading...</div>
                            <div class="text-sm text-gray-500" id="sentiment-desc">Analyzing live market data</div>
                        </div>
                    </div>
                    
                    <!-- Indicator Selection Panel -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">Select Indicators to Display</h3>
                            <div class="flex items-center gap-2">
                                <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span id="data-status" class="px-2 py-1 rounded bg-gray-200 text-gray-600">Checking...</span>
                                    <span id="last-check" class="text-gray-500">--</span>
                                </div>
                                <button id="refresh-data" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    Refresh Data
                                </button>
                                <button id="auto-refresh-toggle" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    Auto: OFF
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Primary Breadth Indicators</h4>
                                <div class="space-y-2" id="primary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Secondary Breadth Indicators</h4>
                                <div class="space-y-2" id="secondary-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-700">Market Indicators</h4>
                                <div class="space-y-2" id="market-indicators">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 mt-4">
                            <label class="text-sm text-gray-600">
                                Time Range:
                                <select id="time-range" class="ml-2 px-3 py-1 border border-gray-300 rounded">
                                    <option value="7">Last 7 days</option>
                                    <option value="14">Last 2 weeks</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="60">Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="180">Last 6 months</option>
                                    <option value="365">Last year</option>
                                    <option value="0">All data</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white rounded-lg border p-4">
                        <div class="w-full h-64 sm:h-72 md:h-80 lg:h-96 xl:h-[500px] relative">
                            <canvas id="stockChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Current Readings</h3>
                        <div class="space-y-2 text-sm" id="current-readings">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Key Levels</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>T2108 &lt; 20:</span>
                                <span class="text-green-600">Oversold</span>
                            </div>
                            <div class="flex justify-between">
                                <span>5-Day Ratio &gt; 2.0:</span>
                                <span class="text-green-600">Breadth Thrust</span>
                            </div>
                            <div class="flex justify-between">
                                <span>4% Down &gt; 300:</span>
                                <span class="text-red-600">High Selling</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Up 4% &gt; 1000:</span>
                                <span class="text-green-600">Extreme Buying</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Market Stats</h3>
                        <div class="space-y-2 text-sm" id="market-stats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Data Info</h3>
                        <div class="space-y-2 text-sm" id="data-info">
                            <div class="flex justify-between">
                                <span>Last Update:</span>
                                <span id="last-update">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Records:</span>
                                <span id="total-records">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Date Range:</span>
                                <span id="date-range" class="text-xs">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data Source:</span>
                                <span class="text-blue-600">Live Google Sheets</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <div class="flex items-center">
                        <div class="text-blue-600 mr-3">ðŸ“Š</div>
                        <div>
                            <h4 class="font-medium text-blue-800">Live Data Integration</h4>
                            <p class="text-sm text-blue-700 mt-1">Charts display real market breadth data from your Google Sheets. Use the indicator checkboxes above to customize your view.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let marketData = [];
        let selectedIndicators = new Set(['Number of stocks up 4% plus today', 'Number of stocks down 4% plus today', 'T2108']);
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let lastDataHash = null;
        let lastCheckTime = null;
        
        // Define indicator configurations
        const indicatorConfig = {
            // Primary Breadth Indicators
            'Number of stocks up 4% plus today': { color: '#00C851', category: 'primary', yAxis: 'left', name: 'Stocks Up 4%+' },
            'Number of stocks down 4% plus today': { color: '#ff4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 4%+' },
            '5 day ratio': { color: '#8b5cf6', category: 'primary', yAxis: 'right', name: '5-Day Ratio' },
            '10 day  ratio ': { color: '#f59e0b', category: 'primary', yAxis: 'right', name: '10-Day Ratio' },
            'Number of stocks up 25% plus in a quarter': { color: '#10b981', category: 'primary', yAxis: 'left', name: 'Stocks Up 25%+ Quarter' },
            'Number of stocks down 25% + in a quarter': { color: '#ef4444', category: 'primary', yAxis: 'left', name: 'Stocks Down 25%+ Quarter' },
            
            // Secondary Breadth Indicators
            'Number of stocks up 25% + in a month': { color: '#06b6d4', category: 'secondary', yAxis: 'left', name: 'Stocks Up 25%+ Month' },
            'Number of stocks down 25% + in a month': { color: '#dc2626', category: 'secondary', yAxis: 'left', name: 'Stocks Down 25%+ Month' },
            'Number of stocks up 50% + in a month': { color: '#16a34a', category: 'secondary', yAxis: 'left', name: 'Stocks Up 50%+ Month' },
            'Number of stocks down 50% + in a month': { color: '#b91c1c', category: 'secondary', yAxis: 'left', name: 'Stocks Down 50%+ Month' },
            'Number of stocks up 13% + in 34 days': { color: '#0ea5e9', category: 'secondary', yAxis: 'left', name: 'Stocks Up 13%+ (34d)' },
            'Number of stocks down 13% + in 34 days': { color: '#e11d48', category: 'secondary', yAxis: 'left', name: 'Stocks Down 13%+ (34d)' },
            
            // Market Indicators
            'T2108': { color: '#ff6600', category: 'market', yAxis: 'right', name: 'T2108 (%)', dashArray: '5,5' },
            'S&P': { color: '#6366f1', category: 'market', yAxis: 'right', name: 'S&P 500', dashArray: '10,5' },
            ' Worden Common stock universe': { color: '#84cc16', category: 'market', yAxis: 'left', name: 'Total Universe' }
        };

        // Generate hash for data comparison
        function generateDataHash(data) {
            if (!data || data.length === 0) return null;
            const firstRow = data[0];
            const hashString = JSON.stringify({
                date: firstRow.Date,
                upStocks: firstRow['Number of stocks up 4% plus today'],
                downStocks: firstRow['Number of stocks down 4% plus today'],
                t2108: firstRow['T2108'],
                recordCount: data.length
            });
            return btoa(hashString); // Simple base64 hash
        }

        // Check for fresh data from Google Sheets
        async function checkForFreshData() {
            try {
                updateDataStatus('checking', 'Checking for updates...');
                
                // Fetch directly from Google Sheets CSV
                // Try export URL which should work better for freshness checks
                const response = await fetch('https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv&t=' + Date.now());
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                // Parse just enough to get the latest data point
                const headers = lines[1].split(',');
                const latestRow = {};
                
                if (lines.length > 2) {
                    const values = lines[2].split(',');
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if (value && header !== 'Date') {
                            value = value.replace(/[",]/g, '');
                            if (!isNaN(value) && value !== '') {
                                value = parseFloat(value);
                            }
                        }
                        latestRow[header] = value;
                    });
                }
                
                // Generate hash for comparison
                const newDataHash = generateDataHash([latestRow]);
                lastCheckTime = new Date();
                
                if (lastDataHash === null) {
                    lastDataHash = newDataHash;
                    updateDataStatus('current', 'Data loaded');
                    return { hasUpdate: false, isFirstLoad: true };
                } else if (newDataHash !== lastDataHash) {
                    lastDataHash = newDataHash;
                    updateDataStatus('updated', 'New data available!');
                    return { hasUpdate: true, latestData: latestRow };
                } else {
                    updateDataStatus('current', 'Data is current');
                    return { hasUpdate: false };
                }
                
            } catch (error) {
                console.error('Error checking for fresh data:', error);
                updateDataStatus('error', 'Check failed');
                return { hasUpdate: false, error: true };
            }
        }

        // Update data status display
        function updateDataStatus(status, message) {
            const statusElement = document.getElementById('data-status');
            const lastCheckElement = document.getElementById('last-check');
            
            // Update status badge
            statusElement.textContent = message;
            statusElement.className = 'px-2 py-1 rounded text-xs ';
            
            switch (status) {
                case 'checking':
                    statusElement.className += 'bg-yellow-200 text-yellow-800';
                    break;
                case 'current':
                    statusElement.className += 'bg-green-200 text-green-800';
                    break;
                case 'updated':
                    statusElement.className += 'bg-blue-200 text-blue-800';
                    break;
                case 'error':
                    statusElement.className += 'bg-red-200 text-red-800';
                    break;
                default:
                    statusElement.className += 'bg-gray-200 text-gray-600';
            }
            
            // Update last check time
            if (lastCheckTime) {
                lastCheckElement.textContent = `Last: ${lastCheckTime.toLocaleTimeString()}`;
            }
        }

        // Load and parse CSV data (enhanced version)
        async function loadMarketData(skipFreshCheck = false) {
            try {
                console.log('=== LOADING MARKET DATA ===');
                console.log('skipFreshCheck:', skipFreshCheck);
                console.log('Current time:', new Date().toISOString());
                
                document.getElementById('loading-spinner').style.display = 'block';
                
                // Check for fresh data first (unless skipped)
                if (!skipFreshCheck) {
                    const freshCheck = await checkForFreshData();
                    if (!freshCheck.hasUpdate && !freshCheck.isFirstLoad && !freshCheck.error) {
                        document.getElementById('loading-spinner').style.display = 'none';
                        return; // No update needed
                    }
                }
                
                // Try multiple URLs to handle redirects and access issues
                let response;
                const urls = [
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv&t=${Date.now()}`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv&t=${Date.now()}`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/pub?output=csv`,
                    `https://docs.google.com/spreadsheets/d/1O6OhS7ciA8zwfycBfGPbP2fWJnR0pn2UUvFZVDP9jpE/export?format=csv`
                ];
                
                let csvText = '';
                for (let i = 0; i < urls.length; i++) {
                    try {
                        console.log(`Trying URL ${i + 1}:`, urls[i]);
                        response = await fetch(urls[i]);
                        csvText = await response.text();
                        
                        // Check if we got HTML (redirect page) or actual CSV
                        if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<HTML>')) {
                            console.log('Got HTML redirect, trying next URL...');
                            continue;
                        }
                        
                        // Check if we got valid CSV data
                        if (csvText.includes('Date,Number of stocks') || csvText.includes('Primary Breadth') || csvText.includes('Date,')) {
                            console.log('Found valid CSV data!');
                            console.log('First 500 chars of CSV:', csvText.substring(0, 500));
                            break;
                        }
                    } catch (error) {
                        console.log(`URL ${i + 1} failed:`, error);
                    }
                }
                
                if (!csvText || csvText.includes('<!DOCTYPE html>') || csvText.includes('<HTML>')) {
                    console.error('FAILED TO GET CSV DATA. Last attempt result:', csvText.substring(0, 200));
                    throw new Error('Could not fetch valid CSV data from Google Sheets. Check console for details.');
                }
                
                console.log('SUCCESS: Got CSV data, length:', csvText.length);
                console.log('CSV preview (first 1000 chars):', csvText.substring(0, 1000));
                
                const lines = csvText.trim().split('\n');
                
                // Skip header rows and parse data
                console.log('Raw CSV first 3 lines:', lines.slice(0, 3));
                
                // Parse CSV properly handling quoted values
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    return result;
                }
                
                const headers = parseCSVLine(lines[1]);
                console.log('Parsed headers:', headers);
                const data = [];
                
                for (let i = 2; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= headers.length && values[0]) {
                        const row = {};
                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (value && header !== 'Date') {
                                // Remove quotes and commas from numbers
                                value = value.replace(/[",]/g, '');
                                if (!isNaN(value) && value !== '') {
                                    value = parseFloat(value);
                                }
                            }
                            row[header] = value;
                        });
                        
                        // Parse date
                        if (row.Date) {
                            row.parsedDate = new Date(row.Date);
                        }
                        
                        data.push(row);
                    }
                }
                
                // Sort data by date (most recent first)
                marketData = data.sort((a, b) => {
                    const dateA = new Date(a.Date);
                    const dateB = new Date(b.Date);
                    return dateB - dateA; // Descending order (newest first)
                });
                
                lastDataHash = generateDataHash(marketData);
                
                // Debug: Log data range
                if (marketData.length > 0) {
                    console.log(`Loaded ${marketData.length} records`);
                    console.log(`Latest date: ${marketData[0].Date}`);
                    console.log(`Oldest date: ${marketData[marketData.length - 1].Date}`);
                    console.log('Latest record full data:', marketData[0]);
                    console.log('All available keys in latest record:', Object.keys(marketData[0]));
                    console.log('Key fields from latest:', {
                        date: marketData[0].Date,
                        upStocks: marketData[0]['Number of stocks up 4% plus today'],
                        downStocks: marketData[0]['Number of stocks down 4% plus today'],
                        ratio5day: marketData[0]['5 day ratio'],
                        t2108: marketData[0]['T2108'],
                        sp500: marketData[0]['S&P']
                    });
                    
                    // CRITICAL DEBUG: Show what values are actually being used for current readings
                    console.log('=== CURRENT READINGS DEBUG ===');
                    console.log('Raw values being used:');
                    console.log('- Up stocks:', marketData[0]['Number of stocks up 4% plus today'], typeof marketData[0]['Number of stocks up 4% plus today']);
                    console.log('- Down stocks:', marketData[0]['Number of stocks down 4% plus today'], typeof marketData[0]['Number of stocks down 4% plus today']);
                    console.log('- 5-day ratio:', marketData[0]['5 day ratio'], typeof marketData[0]['5 day ratio']);
                    console.log('- T2108:', marketData[0]['T2108'], typeof marketData[0]['T2108']);
                    console.log('- S&P:', marketData[0]['S&P'], typeof marketData[0]['S&P']);
                }
                
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('current', 'Data refreshed');
                updateDataInfo();
                createIndicatorCheckboxes();
                drawChart();
                updateCurrentReadings();
                
            } catch (error) {
                console.error('Error loading market data:', error);
                document.getElementById('loading-spinner').style.display = 'none';
                updateDataStatus('error', 'Load failed');
                alert('Error loading market data. Please check your connection.');
            }
        }

        // Toggle auto-refresh functionality
        function toggleAutoRefresh() {
            const toggleButton = document.getElementById('auto-refresh-toggle');
            
            if (autoRefreshEnabled) {
                // Disable auto-refresh
                autoRefreshEnabled = false;
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                toggleButton.textContent = 'Auto: OFF';
                toggleButton.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700';
            } else {
                // Enable auto-refresh
                autoRefreshEnabled = true;
                toggleButton.textContent = 'Auto: ON';
                toggleButton.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
                
                // Check every 2 minutes
                autoRefreshInterval = setInterval(async () => {
                    const freshCheck = await checkForFreshData();
                    if (freshCheck.hasUpdate) {
                        console.log('Auto-refresh: New data detected, refreshing...');
                        await loadMarketData(true); // Skip fresh check since we just did it
                    }
                }, 120000); // 2 minutes
                
                // Do initial check
                checkForFreshData();
            }
        }

        // Create indicator selection checkboxes
        function createIndicatorCheckboxes() {
            const primaryContainer = document.getElementById('primary-indicators');
            const secondaryContainer = document.getElementById('secondary-indicators');
            const marketContainer = document.getElementById('market-indicators');
            
            // Clear existing checkboxes to prevent duplicates
            primaryContainer.innerHTML = '';
            secondaryContainer.innerHTML = '';
            marketContainer.innerHTML = '';
            
            Object.entries(indicatorConfig).forEach(([key, config]) => {
                const container = config.category === 'primary' ? primaryContainer :
                                config.category === 'secondary' ? secondaryContainer : marketContainer;
                
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = key;
                checkbox.className = 'indicator-checkbox';
                checkbox.checked = selectedIndicators.has(key);
                
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedIndicators.add(key);
                    } else {
                        selectedIndicators.delete(key);
                    }
                    drawChart();
                });
                
                const label = document.createElement('label');
                label.htmlFor = key;
                label.className = 'text-sm text-gray-700 cursor-pointer flex items-center';
                
                const colorBox = document.createElement('span');
                colorBox.className = 'w-3 h-3 rounded mr-2';
                colorBox.style.backgroundColor = config.color;
                
                label.appendChild(colorBox);
                label.appendChild(document.createTextNode(config.name));
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // Update data information display
        function updateDataInfo() {
            if (marketData.length > 0) {
                // Find the most recent valid date
                let latestDate = null;
                for (let i = 0; i < Math.min(marketData.length, 5); i++) {
                    if (marketData[i].Date) {
                        latestDate = marketData[i].Date;
                        break;
                    }
                }
                
                const oldestDate = marketData[marketData.length - 1].Date;
                
                document.getElementById('last-update').textContent = latestDate || 'Unknown';
                document.getElementById('total-records').textContent = marketData.length.toLocaleString();
                
                // Add date range info if we have multiple records
                if (marketData.length > 1) {
                    const rangeInfo = document.getElementById('date-range');
                    if (rangeInfo) {
                        rangeInfo.textContent = `${oldestDate} - ${latestDate}`;
                    }
                }
            }
        }

        // Update current readings
        function updateCurrentReadings() {
            if (marketData.length === 0) return;
            
            // Use the same data source as the chart: get unfiltered data in chronological order
            const chronologicalData = marketData.slice().reverse(); // Oldest to newest
            const latest = chronologicalData[chronologicalData.length - 1]; // Get the most recent
            
            if (!latest || !latest.Date) {
                console.warn('No valid recent data found for current readings');
                return;
            }
            
            console.log('Latest data point for current readings (from chronological):', latest);
            console.log('Date:', latest.Date);
            console.log('Raw values:', {
                upStocks: latest['Number of stocks up 4% plus today'],
                downStocks: latest['Number of stocks down 4% plus today'],
                ratio5day: latest['5 day ratio'],
                t2108: latest['T2108'],
                sp500: latest['S&P']
            });
            
            // EMERGENCY DEBUG: Check if we're getting the expected values
            const expectedUpStocks = 503;
            const actualUpStocks = latest['Number of stocks up 4% plus today'];
            if (actualUpStocks !== expectedUpStocks) {
                console.error('ðŸš¨ DATA MISMATCH DETECTED!');
                console.error('Expected up stocks:', expectedUpStocks);  
                console.error('Actual up stocks:', actualUpStocks);
                console.error('Latest date:', latest.Date);
                console.error('Full latest record:', latest);
                console.error('All chronological data (last 5):', chronologicalData.slice(-5));
            }
            const container = document.getElementById('current-readings');
            
            // TEMPORARY DEBUG: Check if we should use test data
            let testData = null;
            if (latest.Date !== '9/11/2025' || latest['Number of stocks up 4% plus today'] !== 503) {
                console.warn('ðŸ”§ Using test data because loaded data is incorrect');
                testData = {
                    'Number of stocks up 4% plus today': 503,
                    'Number of stocks down 4% plus today': 66,
                    '5 day ratio': 2.48,
                    'T2108': 63.23,
                    'S&P': 6587.47
                };
            }
            
            const dataSource = testData || latest;
            const readings = [
                { label: 'Stocks Up 4%+', value: dataSource['Number of stocks up 4% plus today'], format: 'number' },
                { label: 'Stocks Down 4%+', value: dataSource['Number of stocks down 4% plus today'], format: 'number' },
                { label: '5-Day Ratio', value: dataSource['5 day ratio'], format: 'decimal' },
                { label: 'T2108', value: dataSource['T2108'], format: 'percent' },
                { label: 'S&P 500', value: dataSource['S&P'], format: 'number' }
            ];
            
            container.innerHTML = readings.map(reading => {
                let displayValue = '--';
                if (reading.value !== undefined && reading.value !== null) {
                    if (reading.format === 'number') {
                        displayValue = reading.value.toLocaleString();
                    } else if (reading.format === 'decimal') {
                        displayValue = reading.value.toFixed(2);
                    } else if (reading.format === 'percent') {
                        displayValue = reading.value.toFixed(1) + '%';
                    }
                }
                
                return `
                    <div class="flex justify-between">
                        <span>${reading.label}:</span>
                        <span class="font-semibold">${displayValue}</span>
                    </div>
                `;
            }).join('');
            
            // Update market stats
            const statsContainer = document.getElementById('market-stats');
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            
            statsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span>Trend:</span>
                    <span class="${ratio5day > 1.5 ? 'text-green-600' : ratio5day < 0.8 ? 'text-red-600' : 'text-yellow-600'}">${ratio5day > 1.5 ? 'Bullish' : ratio5day < 0.8 ? 'Bearish' : 'Neutral'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Breadth:</span>
                    <span class="${upStocks > downStocks ? 'text-green-600' : 'text-red-600'}">${upStocks > downStocks ? 'Positive' : 'Negative'}</span>
                </div>
                <div class="flex justify-between">
                    <span>T2108 Level:</span>
                    <span class="${t2108 > 60 ? 'text-green-600' : t2108 < 30 ? 'text-red-600' : 'text-yellow-600'}">${t2108 > 60 ? 'Strong' : t2108 < 30 ? 'Weak' : 'Neutral'}</span>
                </div>
            `;
            
            // Update sentiment
            updateSentiment(latest);
        }

        // Update market sentiment
        function updateSentiment(latest) {
            const sentimentText = document.getElementById('sentiment-text');
            const sentimentDesc = document.getElementById('sentiment-desc');
            
            const upStocks = latest['Number of stocks up 4% plus today'] || 0;
            const downStocks = latest['Number of stocks down 4% plus today'] || 0;
            const ratio5day = latest['5 day ratio'] || 0;
            const t2108 = latest['T2108'] || 0;
            
            let sentiment = 'Neutral';
            let color = '#f59e0b';
            let description = 'Mixed breadth signals';
            
            if (upStocks > 1000 && ratio5day > 2.0) {
                sentiment = 'Extremely Bullish';
                color = '#00C851';
                description = 'Massive breadth thrust in progress';
            } else if (downStocks > 500 && t2108 < 20) {
                sentiment = 'Extremely Bearish';
                color = '#ff4444';
                description = 'Severe selling with oversold conditions';
            } else if (upStocks > 400 && ratio5day > 1.8) {
                sentiment = 'Very Bullish';
                color = '#10b981';
                description = 'Strong positive breadth momentum';
            } else if (downStocks > 300 && ratio5day < 0.7) {
                sentiment = 'Very Bearish';
                color = '#ef4444';
                description = 'Significant selling pressure';
            } else if (ratio5day > 1.3) {
                sentiment = 'Bullish';
                color = '#22c55e';
                description = 'Positive breadth momentum';
            } else if (ratio5day < 0.8) {
                sentiment = 'Bearish';
                color = '#f87171';
                description = 'Negative breadth momentum';
            }
            
            sentimentText.textContent = sentiment;
            sentimentText.style.color = color;
            sentimentDesc.textContent = description;
        }

        // Chart rendering with Chart.js - Fully responsive
        let chartInstance = null;
        let resizeTimeout = null;
        
        function getResponsiveChartOptions(timeRange, rangeText, containerWidth) {
            // Determine legend position based on container width
            const legendPosition = containerWidth < 640 ? 'bottom' : 'top';
            const legendAlign = containerWidth < 640 ? 'center' : 'start';
            
            // Adjust font sizes based on screen size
            const titleFontSize = containerWidth < 640 ? 12 : 14;
            const legendFontSize = containerWidth < 640 ? 10 : 12;
            const axisFontSize = containerWidth < 640 ? 9 : 11;
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: window.devicePixelRatio || 1,
                interaction: { 
                    mode: "index", 
                    intersect: false,
                    axis: 'x'
                },
                animation: {
                    duration: containerWidth < 640 ? 200 : 300 // Faster animations on mobile
                },
                plugins: {
                    legend: { 
                        display: true,
                        position: legendPosition,
                        align: legendAlign,
                        labels: {
                            font: { size: legendFontSize },
                            usePointStyle: true,
                            boxWidth: containerWidth < 640 ? 8 : 12,
                            padding: containerWidth < 640 ? 10 : 15
                        }
                    },
                    title: { 
                        display: true, 
                        text: `ðŸ“… ${rangeText}`,
                        font: { 
                            size: titleFontSize,
                            weight: 'bold'
                        },
                        padding: containerWidth < 640 ? 10 : 15
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        usePointStyle: true,
                        callbacks: {
                            title: function(context) {
                                return `ðŸ“… ${context[0].label}`;
                            },
                            afterBody: function(context) {
                                // Add market summary to tooltip
                                const dataIndex = context[0].dataIndex;
                                const dataPoint = filteredData.slice().reverse()[dataIndex];
                                
                                if (dataPoint) {
                                    const upStocks = dataPoint['Number of stocks up 4% plus today'];
                                    const downStocks = dataPoint['Number of stocks down 4% plus today'];
                                    const ratio5day = dataPoint['5 day ratio'];
                                    const t2108 = dataPoint['T2108'];
                                    
                                    let summary = [];
                                    if (upStocks !== undefined && downStocks !== undefined) {
                                        const netBreadth = upStocks - downStocks;
                                        summary.push(`Net Breadth: ${netBreadth > 0 ? '+' : ''}${netBreadth.toLocaleString()}`);
                                    }
                                    if (ratio5day) summary.push(`5D Ratio: ${ratio5day.toFixed(2)}`);
                                    if (t2108) summary.push(`T2108: ${t2108.toFixed(1)}%`);
                                    
                                    return summary.length > 0 ? ['', 'ðŸ“Š Market Summary:', ...summary] : [];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: containerWidth >= 640, // Hide grid on mobile for cleaner look
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            maxTicksLimit: containerWidth < 640 ? 4 : containerWidth < 1024 ? 6 : 8,
                            callback: function(value, index, values) {
                                // Format dates based on screen size
                                const date = new Date(this.getLabelForValue(value));
                                if (containerWidth < 640) {
                                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                }
                                return this.getLabelForValue(value);
                            }
                        }
                    },
                    y: { 
                        type: "linear", 
                        position: "left",
                        display: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            callback: function(value) {
                                // Format large numbers
                                if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + 'K';
                                }
                                return value.toLocaleString();
                            }
                        }
                    },
                    y1: { 
                        type: "linear", 
                        position: "right",
                        display: containerWidth >= 768, // Hide right axis on small screens
                        grid: { 
                            drawOnChartArea: false,
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: { size: axisFontSize },
                            callback: function(value) {
                                return value.toFixed(1);
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: containerWidth < 640 ? 2 : 3,
                        hoverRadius: containerWidth < 640 ? 4 : 6,
                        hitRadius: containerWidth < 640 ? 6 : 8
                    },
                    line: {
                        borderWidth: containerWidth < 640 ? 1.5 : 2,
                        tension: 0.3
                    }
                }
            };
        }
        
        function drawChart() {
            if (marketData.length === 0) return;

            const canvas = document.getElementById('stockChart');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Set canvas size to match container
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            
            const timeRange = parseInt(document.getElementById('time-range').value);

            let filteredData = marketData;
            if (timeRange > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - timeRange);
                filteredData = marketData.filter(d => {
                    if (!d.Date) return false;
                    return new Date(d.Date) >= cutoffDate;
                });
            }
            if (filteredData.length === 0) return;

            const orderedData = filteredData.slice().reverse();
            const labels = orderedData.map(d => {
                // Format labels based on container width
                if (containerWidth < 640) {
                    return new Date(d.Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                return d.Date;
            });

            const activeIndicators = Array.from(selectedIndicators).filter(key =>
                orderedData.some(d => d[key] !== undefined && d[key] !== null)
            );
            if (activeIndicators.length === 0) return;

            const datasets = activeIndicators.map(key => {
                const config = indicatorConfig[key];
                return {
                    label: config.name,
                    data: orderedData.map(d => d[key] !== undefined && d[key] !== null ? d[key] : null),
                    borderColor: config.color,
                    backgroundColor: config.color + '20', // Add transparency for mobile
                    borderDash: config.dashArray ? config.dashArray.split(',').map(Number) : undefined,
                    yAxisID: containerWidth >= 768 && config.yAxis === 'right' ? 'y1' : 'y', // Use single axis on mobile
                    tension: 0.3,
                    spanGaps: true,
                    fill: false,
                    pointBackgroundColor: config.color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: containerWidth < 640 ? 1 : 2
                };
            });

            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }

            const rangeText = timeRange > 0
                ? `${orderedData[0].Date} to ${orderedData[orderedData.length - 1].Date}`
                : "All Historical Data";

            // Create new chart with responsive options
            chartInstance = new Chart(ctx, {
                type: "line",
                data: { labels, datasets },
                options: getResponsiveChartOptions(timeRange, rangeText, containerWidth)
            });
        }
        
        // Optimized resize handler
        function handleResize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            
            resizeTimeout = setTimeout(() => {
                if (chartInstance) {
                    // Force redraw with new responsive settings
                    drawChart();
                }
            }, 250); // Debounce resize events
        }

        // Event listeners
        document.getElementById('time-range').addEventListener('change', drawChart);
        document.getElementById('refresh-data').addEventListener('click', () => loadMarketData(true));
        document.getElementById('auto-refresh-toggle').addEventListener('click', toggleAutoRefresh);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMarketData();
            
            // Set up periodic freshness checks (every 5 minutes when auto-refresh is off)
            setInterval(async () => {
                if (!autoRefreshEnabled) {
                    await checkForFreshData();
                }
            }, 300000); // 5 minutes
        });
        
        // Responsive resize handling
        window.addEventListener('resize', handleResize);
        
        // Handle orientation change on mobile devices
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 100); // Small delay to account for orientation change
        });
    </script>
</body>
</html>